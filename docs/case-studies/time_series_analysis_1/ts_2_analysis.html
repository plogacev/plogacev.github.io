<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Pavel Logačev">
<title>Bayesian Analysis of Sales – Pavel Logačev</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-05cd2c980c80e471fe59e1e83b01035b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Pavel Logačev",
  "jobTitle": "Freelance Data Scientist",
  "description": "Freelance data scientist specializing in statistical modeling, Bayesian methods, demand modeling, price elasticity, and causal inference.",
  "url": "https://plogacev.github.io",
  "image": "https://plogacev.github.io/assets/images/pavel.png",
  "sameAs": [
    "https://www.linkedin.com/in/pavel-logacev",
    "https://github.com/plogacev"
  ],
  "knowsAbout": [
    "Data Science",
    "Statistical Modeling",
    "Bayesian Methods",
    "Demand Modeling",
    "Price Elasticity",
    "Causal Inference",
    "Forecasting",
    "Machine Learning"
  ],
  "alumniOf": {
    "@type": "CollegeOrUniversity",
    "name": "University of Potsdam"
  },
  "hasCredential": {
    "@type": "EducationalOccupationalCredential",
    "credentialCategory": "PhD",
    "about": "Cognitive Science"
  },
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Berlin",
    "addressCountry": "Germany"
  }
}
</script><link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
<meta property="og:title" content="Bayesian Analysis of Sales">
<meta property="og:description" content="Freelance Data Scientist specializing in Bayesian methods, demand modeling, price elasticity, and causal inference.">
<meta property="og:site_name" content="Pavel Logačev">
<meta name="twitter:title" content="Bayesian Analysis of Sales">
<meta name="twitter:description" content="Freelance Data Scientist specializing in Bayesian methods, demand modeling, price elasticity, and causal inference.">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Pavel Logačev</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../case-studies/index.html"> 
<span class="menu-text">Case Studies</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../contact.html"> 
<span class="menu-text">Contact</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/plogacev" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="https://www.linkedin.com/in/pavel-logacev" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#bayesian-analysis-of-sales" id="toc-bayesian-analysis-of-sales" class="nav-link active" data-scroll-target="#bayesian-analysis-of-sales">Bayesian Analysis of Sales</a>
  <ul class="collapse">
<li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#import-required-libraries-and-define-functions" id="toc-import-required-libraries-and-define-functions" class="nav-link" data-scroll-target="#import-required-libraries-and-define-functions">Import Required Libraries And Define Functions</a></li>
  <li>
<a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">1. Model</a>
  <ul class="collapse">
<li><a href="#auxiliary-functions" id="toc-auxiliary-functions" class="nav-link" data-scroll-target="#auxiliary-functions">1.1 Auxiliary Functions</a></li>
  <li><a href="#model-1" id="toc-model-1" class="nav-link" data-scroll-target="#model-1">1.2 Model</a></li>
  </ul>
</li>
  <li>
<a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model">2. Fit the Model</a>
  <ul class="collapse">
<li><a href="#model-fitting-logic" id="toc-model-fitting-logic" class="nav-link" data-scroll-target="#model-fitting-logic">2.1 Model Fitting Logic</a></li>
  <li><a href="#fit-the-model-to-the-synthetic-dataset" id="toc-fit-the-model-to-the-synthetic-dataset" class="nav-link" data-scroll-target="#fit-the-model-to-the-synthetic-dataset">2.2 Fit the Model to the Synthetic Dataset</a></li>
  <li><a href="#inspect-the-mcmc-results" id="toc-inspect-the-mcmc-results" class="nav-link" data-scroll-target="#inspect-the-mcmc-results">2.3 Inspect the MCMC results</a></li>
  </ul>
</li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">3. Conclusion</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Bayesian Analysis of Sales</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Pavel Logačev </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    
  </div>
  


</header><section id="bayesian-analysis-of-sales" class="level1"><h1>Bayesian Analysis of Sales</h1>
<p>This notebook demonstrates the use of Bayesian inference for sales forecasting using various probabilistic programming techniques. We will use the <code>numpyro</code> library to define and fit our models, and <code>plotnine</code> for visualization.</p>
<section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Bayesian inference allows us to incorporate prior knowledge and quantify uncertainty in our predictions. This notebook will guide you through the process of building a Bayesian model for sales forecasting, fitting the model using Markov Chain Monte Carlo (MCMC) and Stochastic Variational Inference (SVI), and visualizing the results.</p>
</section><section id="import-required-libraries-and-define-functions" class="level2"><h2 class="anchored" data-anchor-id="import-required-libraries-and-define-functions">Import Required Libraries And Define Functions</h2>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/">reticulate</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set XLA_FLAGS before JAX is imported</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"XLA_FLAGS"</span>] <span class="op">=</span> <span class="st">"--xla_force_host_platform_device_count=8"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> ggplot, aes, geom_point, geom_line, labs, theme_minimal, theme_bw, scale_x_continuous, scale_x_discrete, scale_x_datetime</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> patsy</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.random <span class="im">as</span> random</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.scipy.special <span class="im">import</span> expit, logit</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro.distributions <span class="im">as</span> dist</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#from numpyro.infer import SVI, Trace_ELBO, Predictive</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer <span class="im">import</span> MCMC, NUTS, MCMC, NUTS <span class="co">#, SVI, Trace_ELBO</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> theme, guides, guide_legend</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">#jax.config.update("jax_enable_x64", True)  # Enable float64 by default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="model" class="level2"><h2 class="anchored" data-anchor-id="model">1. Model</h2>
<p>In this section, we define the Bayesian model used for sales forecasting. The model incorporates various components such as random walk for the latent state, day-of-the-week effects, day-of-the-year effects, and price elasticity. The model is implemented using the <code>numpyro</code> library, which allows for efficient and scalable Bayesian inference.</p>
<section id="auxiliary-functions" class="level3"><h3 class="anchored" data-anchor-id="auxiliary-functions">1.1 Auxiliary Functions</h3>
<p>These auxiliary functions are essential for data preprocessing and transformation:</p>
<ul>
<li>
<code>periodic_rbf</code>: Computes a periodic Gaussian radial basis function (RBF).</li>
<li>
<code>compute_doy_basis</code>: Computes 12 periodic Gaussian basis functions for seasonal effects.</li>
<li>
<code>read_data</code>: Reads and preprocesses the sales data from a CSV file.</li>
<li>
<code>init_values</code>: Initializes values for the model parameters.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a periodic Gaussian radial basis function (RBF)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> periodic_rbf(x, mu, sigma):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes a periodic Gaussian radial basis function (RBF).</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">        x: Scaled day-of-year values (range [0,1]).</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        mu: Center of the Gaussian basis function.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">        sigma: Controls the spread of the Gaussian.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">        RBF values preserving periodicity.</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute cyclic distance to mu</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    periodic_distance <span class="op">=</span> jnp.minimum(jnp.<span class="bu">abs</span>(x <span class="op">-</span> mu), <span class="dv">1</span> <span class="op">-</span> jnp.<span class="bu">abs</span>(x <span class="op">-</span> mu))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute RBF value</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.exp(<span class="op">-</span> (periodic_distance <span class="op">**</span> <span class="dv">2</span>) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> sigma <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_doy_basis(yday_fraction, sigma <span class="op">=</span> <span class="dv">30</span><span class="op">/</span><span class="fl">365.25</span>, n_centers <span class="op">=</span> <span class="dv">12</span>):</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes 12 periodic Gaussian basis functions for seasonal effects.</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">        yday_fraction: Normalized day of the year (range [0,1]).</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">        yday_factor: Scaling factor for basis function width.</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">        A JAX array with 12 columns representing the 12 monthly basis functions.</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define centers of Gaussian basis functions</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    month_centers <span class="op">=</span> jnp.linspace( <span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>n_centers), <span class="dv">1</span><span class="op">-</span><span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>n_centers), n_centers)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate an array of shape (length of input, 12) with the RBF values</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    doy_basis <span class="op">=</span> jnp.stack([periodic_rbf(yday_fraction, mu, sigma) <span class="cf">for</span> mu <span class="kw">in</span> month_centers], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subtract each row's mean to enforce sum-to-zero constraint</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    doy_basis_centered <span class="op">=</span> doy_basis <span class="op">-</span> jnp.mean(doy_basis, axis<span class="op">=-</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> doy_basis_centered</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(fname, n_rows<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Reads and preprocesses the sales data from a CSV file.</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co">        fname: The filename of the CSV file containing the sales data.</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co">        A dictionary with the following keys:</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="co">            - sales: An array of sales data.</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co">            - log_price: An array of log-transformed prices.</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="co">            - wday: An array of day-of-the-week values.</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co">            - yday_fraction: An array of normalized day-of-the-year values.</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file using polars</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pl.read_csv(fname)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only the first n_rows if specified</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_rows <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.head(n_rows)</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the 'date' column to date type</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.with_columns(pl.col(<span class="st">"date"</span>).<span class="bu">str</span>.to_date())</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract sales, and log price data as a numpy arrays</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    sales <span class="op">=</span> df[<span class="st">"sales"</span>].to_numpy()</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    log_price <span class="op">=</span> df[<span class="st">"log_price"</span>].to_numpy()</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract day-of-the-week values</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    wday <span class="op">=</span> df[<span class="st">"date"</span>].dt.weekday().to_numpy() <span class="co"># set offset to 0</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract day-of-the-year values</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    yday <span class="op">=</span> df[<span class="st">"date"</span>].dt.ordinal_day().to_numpy()</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine if the year is a leap year</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    is_leap_year <span class="op">=</span> df[<span class="st">"date"</span>].dt.is_leap_year().to_numpy()</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize day-of-the-year values</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    yday_fraction <span class="op">=</span> yday <span class="op">/</span> (<span class="dv">365</span> <span class="op">+</span> is_leap_year)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the preprocessed data as a dictionary</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: df[<span class="st">"date"</span>].to_numpy(),</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sales"</span>: sales,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_price"</span>: log_price,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wday"</span>: wday,</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yday_fraction"</span>: yday_fraction</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> interpolate(x, downsampling_factor, n_out):</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    idx_n_weight <span class="op">=</span> jnp.array(<span class="bu">range</span>(<span class="dv">0</span>, n_out))<span class="op">/</span>jnp.float64(downsampling_factor)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    idx_1 <span class="op">=</span> jnp.array( jnp.floor(idx_n_weight), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    idx_2 <span class="op">=</span> jnp.array( jnp.ceil(idx_n_weight), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    weight_2 <span class="op">=</span> idx_n_weight <span class="op">-</span> idx_1</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    state_before <span class="op">=</span> x[idx_1]</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    state_after  <span class="op">=</span> x[idx_2]</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">1</span><span class="op">-</span>weight_2)<span class="op">*</span>state_before <span class="op">+</span> weight_2<span class="op">*</span>state_after</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunked_mean(x, n_chunk):</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> x.shape[<span class="dv">0</span>]</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    pad_size <span class="op">=</span> <span class="op">-</span>n <span class="op">%</span> n_chunk <span class="co"># compute padding needed to make k a multiple of n</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    x_padded <span class="op">=</span> jnp.pad(array <span class="op">=</span> x, pad_width <span class="op">=</span> (<span class="dv">0</span>, pad_size), mode <span class="op">=</span> <span class="st">'edge'</span>) <span class="co"># pad at the end</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_padded.reshape(<span class="op">-</span><span class="dv">1</span>, n_chunk).mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunked_sum(x, n_chunk):</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> x.shape[<span class="dv">0</span>]</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    pad_size <span class="op">=</span> <span class="op">-</span>n <span class="op">%</span> n_chunk <span class="co"># compute padding needed to make k a multiple of n</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>    x_padded <span class="op">=</span> jnp.pad(array <span class="op">=</span> x, pad_width <span class="op">=</span> (<span class="dv">0</span>, pad_size)) <span class="co"># pad at the end</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_padded.reshape(<span class="op">-</span><span class="dv">1</span>, n_chunk).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a simple plot using plotnine</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_function(x, y, title, xlab, ylab):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert x to numpy array</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.array(x)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if y is a callable function</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">callable</span>(y):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If y is a function, apply it to x and create a DataFrame</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame({<span class="st">"x"</span>: x, <span class="st">"y"</span>: y(x)})</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If y is not a function, create a DataFrame directly</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame({<span class="st">"x"</span>: x, <span class="st">"y"</span>: y})        </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the plot using ggplot</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    plot <span class="op">=</span> (ggplot(df, aes(x<span class="op">=</span><span class="st">"x"</span>, y<span class="op">=</span><span class="st">"y"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> labs(title<span class="op">=</span>title, x<span class="op">=</span>xlab, y<span class="op">=</span>ylab) <span class="op">+</span> theme_bw())</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the plot</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="model-1" class="level3"><h3 class="anchored" data-anchor-id="model-1">1.2 Model</h3>
<section id="key-features" class="level4"><h4 class="anchored" data-anchor-id="key-features">1.2.1 Key Features</h4>
<ul>
<li>Sales are modeled using a <strong>stochastic Poisson process</strong>, where the expected rate <span class="math inline">\(\lambda_t\)</span> evolves over time.</li>
<li>The <strong>latent sales rate</strong> follows a random walk, allowing it to drift nonstationarily.</li>
<li>
<strong>Seasonal components</strong> (day-of-the-week and annual patterns) adjust for structured demand variations.</li>
<li>
<strong>Price elasticity</strong> is explicitly modeled, ensuring sensitivity to pricing dynamics.</li>
<li>The model is implemented in numpyro, enabling scalable Bayesian inference.</li>
</ul></section><section id="model-overview" class="level4"><h4 class="anchored" data-anchor-id="model-overview">1.2.1 Model Overview</h4>
<p>We model the sales time series as a <strong>stochastic process</strong> where the underlying rate of sales evolves over time. This evolution follows a <strong>random walk structure</strong>, but with systematic adjustments for covariates such as price, day-of-the-week effects, and day-of-the-year effects. The rate of sales <span class="math inline">\(\lambda_t\)</span> on day <span class="math inline">\(t\)</span> is a function of captures <em>(i)</em> systematic covariate effects (<span class="math inline">\(z_t\)</span>), <em>(ii)</em> a global baseline (<span class="math inline">\(\mu_\tau\)</span>), and <em>(iii)</em> the latent dynamic component (<span class="math inline">\(\tau_t\)</span>).</p>
<p><span class="math display">\[
log~\lambda_t = z_t + \mu_\tau + \tau_t
\]</span></p>
<section id="latent-states-dynamics" class="level5"><h5 class="anchored" data-anchor-id="latent-states-dynamics">1.2.1.1 Latent States Dynamics</h5>
<p>The baseline sales level <span class="math inline">\(\tau_t\)</span> follows a <strong>random walk</strong>. Because all contrast matrices for structured effects are centered, <span class="math inline">\(\mu_\tau + \tau_t\)</span> can be interpreted as the average latent sales rate on <span class="math inline">\(\tau_t\)</span>.</p>
<p><span class="math display">\[
\tau_t = \tau_{t-1} + \delta_t, \quad \delta_t \sim \mathcal{N}(0, \sigma_\tau)
\]</span></p>
<p>with:</p>
<p><span class="math display">\[
\mu_\tau \sim \text{Exponential}(1), \quad \sigma_\tau \sim \mathcal{N}(1)
\]</span></p>
</section><section id="structured-effects" class="level5"><h5 class="anchored" data-anchor-id="structured-effects">1.2.1.2 Structured Effects</h5>
<p>We further accounted for systematic effects of <em>(i)</em> day of the week, <em>(ii)</em> day of the year, and <em>(iii)</em> price.</p>
<ul>
<li>For day of the week effects, we used a contrast matrix <span class="math inline">\(\mathbf{C}_{\text{wday}}\)</span> with sliding differences.</li>
<li>For day of the year effects, we used a matrix of Gaussian radial basis functions <span class="math inline">\(\mathbf{B}_{\text{yday}}\)</span>.</li>
<li>Price elasticity is modelled using a centered log price</li>
</ul>
<p>Similarly, the day-of-the-year effects are modeled using a seasonality basis matrix <span class="math inline">\(\mathbf{B}_{\text{yday}}\)</span>, which represents periodic seasonal patterns using Gaussian radial basis functions (RBFs).</p>
<ul>
<li>
<strong>Day-of-the-week effects</strong>:</li>
</ul>
<p><span class="math display">\[
  zw_t = \mathbf{C}_{\text{wday}} \cdot \beta_{\text{wday}}, \quad \beta_{\text{wday}} \sim \mathcal{N}(0, 1)
\]</span></p>
<ul>
<li>
<strong>Day-of-the-year effects</strong>:</li>
</ul>
<p><span class="math display">\[
  zy_t = \mathbf{B}_{\text{yday}} \cdot \beta_{\text{yday}}, \quad \beta_{\text{yday}} \sim \mathcal{N}(0, 1)
\]</span></p>
<ul>
<li>
<strong>Price elasticity</strong>:</li>
</ul>
<p><span class="math display">\[
  ze_t = \text{log\_price\_centered} \cdot e, \quad \log(-e) \sim \mathcal{N^{+}}(0, 1)
\]</span></p>
<ul>
<li>
<strong>Sum of structural effects</strong>:</li>
</ul>
<p><span class="math display">\[
  z_t = zw_t + zy_t + ze_t
\]</span></p>
</section><section id="emissions-model" class="level5"><h5 class="anchored" data-anchor-id="emissions-model">1.2.1.3 Emissions Model</h5>
<p>Observed sales are assumed to follow a <strong>Poisson distribution</strong>, ensuring discrete, non-negative observations:</p>
<p><span class="math display">\[
S_t \sim \text{Poisson}(\lambda_t)
\]</span></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_local_level_poisson(sales: jnp.array, log_price_centered: jnp.array, wday: jnp.array, yday_fraction: jnp.array, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                              contrasts_sdif_t: jnp.array, contrasts_wday: jnp.array, contrasts_yday: jnp.array, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                              downsampling_factor <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="op">=</span> <span class="bu">len</span>(sales)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    n_states <span class="op">=</span> contrasts_sdif_t.shape[<span class="dv">0</span>]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_random_walk(contrasts_sdif_t, n_states):</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        log_sigma <span class="op">=</span> numpyro.sample(<span class="st">"log_sigma"</span>, dist.Gumbel(<span class="dv">0</span>, <span class="dv">5</span>))</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> numpyro.deterministic(<span class="st">"sigma"</span>, jnp.exp(log_sigma))</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        log_state_mean <span class="op">=</span> numpyro.sample(<span class="st">"log_state_mean"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">5</span>)) <span class="co"># to-do: add an average drift term, as well as potentially an additional parameter governing drift dynamics </span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        log_state_delta <span class="op">=</span> numpyro.sample( <span class="st">"log_state_delta"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">1</span>), sample_shape<span class="op">=</span>(n_states<span class="op">-</span><span class="dv">1</span>,))</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> numpyro.deterministic(<span class="st">"log_state_base"</span>, jnp.dot(contrasts_sdif_t, log_state_delta) <span class="op">*</span> sigma <span class="op">+</span> log_state_mean )</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> log_state_base</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_downsampled_random_walk(contrasts_sdif_t, n_obs, n_states):</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        log_state_base_downsampled <span class="op">=</span> sample_random_walk(contrasts_sdif_t, n_states)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> interpolate(log_state_base_downsampled, downsampling_factor, n_obs)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> log_state_base</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_wday_effect(contrasts_wday, wday):</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior for day-of-the-week effects (6 coefficients)</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        wday_coefficients <span class="op">=</span> numpyro.sample(<span class="st">"wday_coefficients"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">1</span>), sample_shape<span class="op">=</span>(<span class="dv">6</span>,))</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute wday effect per observation (sum-to-zero constraint applied via contrasts)</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        wday_effects <span class="op">=</span> jnp.dot(contrasts_wday, wday_coefficients)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jnp.array(wday_effects[wday<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_yday_effect(contrasts_yday, yday_fraction):</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior for yearly seasonality effects (12 coefficients)</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        yday_coefficients <span class="op">=</span> numpyro.sample(<span class="st">"yday_coefficients"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">1</span>), sample_shape<span class="op">=</span>(<span class="dv">12</span>,))</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jnp.dot(contrasts_yday, yday_coefficients)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_price_effect(log_price_centered):</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior for price elasticity</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        elasticity_pos <span class="op">=</span> numpyro.sample( <span class="st">"elasticity_pos"</span>, dist.HalfNormal(<span class="dv">10</span>) )</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        elasticity <span class="op">=</span> numpyro.deterministic(<span class="st">"elasticity"</span>, <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> elasticity_pos)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> log_price_centered <span class="op">*</span> elasticity</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample random walk    </span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_obs <span class="op">==</span> n_states:</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> sample_random_walk(contrasts_sdif_t, n_states)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> sample_downsampled_random_walk(contrasts_sdif_t, n_obs, n_states)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample day-of-the-week effects</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    wday_effect <span class="op">=</span> sample_wday_effect(contrasts_wday, wday)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample day-of-the-year effects</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    yday_effect <span class="op">=</span> sample_yday_effect(contrasts_yday, yday_fraction)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample elasticity effect</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    price_effect <span class="op">=</span> sample_price_effect(log_price_centered)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute state</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> numpyro.deterministic(<span class="st">"state"</span>, jnp.exp( log_state_base  <span class="op">+</span> yday_effect <span class="op">+</span> wday_effect <span class="op">+</span> price_effect )) <span class="co">#   # </span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute log-likelihood for poisson emissions</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    numpyro.sample(<span class="st">"sales"</span>, dist.Poisson(rate<span class="op">=</span>state), obs<span class="op">=</span>sales) <span class="co"># to-do: create a Poisson distribution paramaterized by log-rate, as in the Stan manual </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section></section></section><section id="fit-the-model" class="level2"><h2 class="anchored" data-anchor-id="fit-the-model">2. Fit the Model</h2>
<p>We use the <code>run_nuts</code> function to fit the model to our sales data. The function leverages the No-U-Turn Sampler (NUTS) from the <code>numpyro</code> library to perform MCMC sampling. Because the model has a large number of latent parameters, initialization to sensible start values is key.</p>
<section id="model-fitting-logic" class="level3"><h3 class="anchored" data-anchor-id="model-fitting-logic">2.1 Model Fitting Logic</h3>
<p>In order to fit the model, the functions below are used:</p>
<ol type="1">
<li><p><code>prepare_model_arguments</code>: Transforms the data into a format required by the model, including sales data, log-transformed prices, day-of-the-week values, and normalized day-of-the-year values.</p></li>
<li><p><code>init_values</code>: Finds sensible start values for the model parameters which, in this case is crucial for the convergence of the MCMC algorithm.</p></li>
<li><p><code>run_nuts</code>: Given a dataset, it calls the NUTS sampler to perform MCMC sampling.</p></li>
</ol>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_values(sales: jnp.array, log_price_centered: jnp.array, wday, yday_fraction: jnp.array, downsampling_factor <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    log_state_est <span class="op">=</span> jnp.log(sales <span class="op">+</span> epsilon)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    log_state_mean_est <span class="op">=</span> jnp.mean(log_state_est)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    log_state_delta_est <span class="op">=</span> jnp.diff(log_state_est)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> downsampling_factor <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        log_state_delta_est <span class="op">=</span> chunked_sum(log_state_delta_est, downsampling_factor)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    log_state_delta_sd_est <span class="op">=</span> jnp.std(log_state_delta_est)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_sigma"</span>: jnp.log( log_state_delta_sd_est ),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_state_mean"</span>: log_state_mean_est,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_state_delta"</span>: log_state_delta_est,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wday_coefficients"</span>: jnp.array([<span class="fl">0.0</span>]<span class="op">*</span><span class="dv">6</span>),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yday_coefficients"</span>: jnp.array([<span class="fl">0.0</span>]<span class="op">*</span><span class="dv">12</span>),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_elasticity"</span>: jnp.array([<span class="fl">0.0</span>])</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_model_arguments(sales: jnp.array, log_price: jnp.array, wday: jnp.array, yday_fraction: jnp.array, downsampling_factor <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepares the arguments required for the model.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">        sales: Array of sales data.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">        log_price: Array of log-transformed prices.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">        wday: Array of day-of-the-week values.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">        yday_fraction: Array of normalized day-of-the-year values.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">        downsampling_factor: Factor by which to downsample the data.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">        A tuple containing initialized values for the model parameters and the model arguments.</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span>    </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="op">=</span> <span class="bu">len</span>(sales)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the number of states based on the downsampling factor</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> downsampling_factor <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        n_states <span class="op">=</span> n_obs</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        n_states <span class="op">=</span> <span class="bu">int</span>(np.ceil(n_obs <span class="op">/</span> downsampling_factor) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define contrast matrix for random walk (T coefficients, sum-to-zero constraint)</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    contrasts_sdif_t <span class="op">=</span> patsy.contrasts.Diff().code_without_intercept(<span class="bu">range</span>(<span class="dv">0</span>, n_states)).matrix</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define contrast matrix for day-of-the-week effects (6 coefficients, sum-to-zero constraint)</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    contrasts_wday <span class="op">=</span> patsy.contrasts.Diff().code_without_intercept(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">7</span>)).matrix  <span class="co"># 7 days → 6 contrasts</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute yday effect per observation (sum-to-zero constraint applied via contrasts)</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    contrasts_yday <span class="op">=</span> compute_doy_basis(yday_fraction, sigma<span class="op">=</span><span class="dv">30</span><span class="op">/</span><span class="fl">365.25</span>, n_centers<span class="op">=</span><span class="dv">12</span>) <span class="co"># to-do: do a very approximate calibration of the RBF width parameter sigma, using something like a spline for the long term trend + RBF seasonality</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute centered log price differences</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    log_price_centered <span class="op">=</span> log_price <span class="op">-</span> jnp.mean(log_price)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the model parameters</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    model_arguments <span class="op">=</span> {</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sales'</span>: sales,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'log_price_centered'</span>: log_price_centered,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'wday'</span>: jnp.array(wday, dtype<span class="op">=</span><span class="bu">int</span>),</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'yday_fraction'</span>: yday_fraction,</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'downsampling_factor'</span>: downsampling_factor,</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contrasts_sdif_t'</span>: contrasts_sdif_t,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contrasts_wday'</span>: contrasts_wday,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contrasts_yday'</span>: contrasts_yday</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare initial values for parameters </span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    init_params <span class="op">=</span> init_values(sales, log_price_centered, wday, yday_fraction, downsampling_factor)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> init_params, model_arguments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_nuts(sales: jnp.array, log_price: jnp.array, wday, yday_fraction: jnp.array, downsampling_factor <span class="op">=</span> <span class="dv">1</span>, n_chains <span class="op">=</span> <span class="dv">1</span>, num_warmup<span class="op">=</span><span class="dv">1_000</span>, num_samples<span class="op">=</span><span class="dv">1_000</span>, step_size<span class="op">=</span><span class="fl">0.01</span>, max_tree_depth<span class="op">=</span><span class="dv">8</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Runs NUTS MCMC inference on the model </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize random number generator key</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    rng_key <span class="op">=</span> random.PRNGKey(<span class="dv">0</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the number of observations</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="op">=</span> <span class="bu">len</span>(sales)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare model arguments and initial parameter values</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    init_params, model_arguments <span class="op">=</span> prepare_model_arguments(sales <span class="op">=</span> sales, log_price <span class="op">=</span> log_price, wday <span class="op">=</span> wday, yday_fraction <span class="op">=</span> yday_fraction, downsampling_factor <span class="op">=</span> downsampling_factor)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split the random number generator key</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    rng_key, rng_key_ <span class="op">=</span> random.split(rng_key)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the number of chains for parallel sampling</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    numpyro.set_host_device_count(n_chains)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the model to be used</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    reparam_model <span class="op">=</span> model_local_level_poisson</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the NUTS kernel with the specified step size and tree depth</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    kernel <span class="op">=</span> NUTS(reparam_model, step_size<span class="op">=</span>step_size, max_tree_depth<span class="op">=</span>max_tree_depth)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the MCMC sampler with the NUTS kernel</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    mcmc <span class="op">=</span> MCMC(kernel, num_warmup<span class="op">=</span>num_warmup, num_samples<span class="op">=</span>num_samples, num_chains<span class="op">=</span>n_chains)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run the MCMC sampler</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    mcmc.run(rng_key_, <span class="op">**</span>model_arguments) <span class="co"># disable init values: init_params=init_params</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the fitted MCMC object</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mcmc, model_arguments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="fit-the-model-to-the-synthetic-dataset" class="level3"><h3 class="anchored" data-anchor-id="fit-the-model-to-the-synthetic-dataset">2.2 Fit the Model to the Synthetic Dataset</h3>
<ul>
<li>We fit the model to the synthetic dataset using the <code>run_nuts</code> function. The model is fitted using the No-U-Turn Sampler (NUTS) from the <code>numpyro</code> library, with 4 chains, 1,000 warmup iterations, and 1,000 sampling iterations. The step size is set to 0.01, and the maximum tree depth is 8. The fitted model is stored in the <code>m_fit</code> variable.</li>
<li>On CPU, the process takes about 2 minutes.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the synthetic sales data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> read_data(<span class="st">"sales_synthetic.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"sim_parameters.pkl"</span>, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    sim_parameters <span class="op">=</span> date_range, growth, growth_plus_rw, scale_factor, wday, weekly_seasonality, yearly_seasonality <span class="op">=</span> pickle.load(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model using NumPyro NUTS MCMC</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>m_fit, model_arguments <span class="op">=</span> run_nuts(data[<span class="st">'sales'</span>], data[<span class="st">'log_price'</span>], data[<span class="st">'wday'</span>], data[<span class="st">'yday_fraction'</span>], </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                                    downsampling_factor<span class="op">=</span><span class="dv">7</span>, n_chains<span class="op">=</span><span class="dv">4</span>, num_warmup<span class="op">=</span><span class="dv">1_000</span>, num_samples<span class="op">=</span><span class="dv">1_000</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                                    step_size<span class="op">=</span><span class="fl">0.01</span>, max_tree_depth<span class="op">=</span><span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="inspect-the-mcmc-results" class="level3"><h3 class="anchored" data-anchor-id="inspect-the-mcmc-results">2.3 Inspect the MCMC results</h3>
<ul>
<li><p>All effective sample sizes are decent, which is a good sign. The Gelman-Rubin statistics are close to 1, indicating convergence. Inspection of trace plots are beyond the scope of this notebook.</p></li>
<li><p>The model successfully reconstructs all key features of the synthetic dataset.</p></li>
</ul>
<section id="random-walk-component" class="level4"><h4 class="anchored" data-anchor-id="random-walk-component">2.3.1 Random Walk Component</h4>
<ul>
<li>The estimated random walk component closely follows the true trajectory of the combination long-term trend + random fluctuations in the synthetic data.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's look at the estimated random walk component of the model.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"sigma"</span>, <span class="st">"log_state_delta"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ul>
<li>Here, we’ll plot the estimated the random walk component, which also incorporates long term trends and growth or decline of sales. For present purposes, this is what amounts to irrelevant noise in the model.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sequence of dates starting at data["date"].min() the length of x['mean'], in steps of 7 days</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>rw_states <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"log_state_base"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)[<span class="st">"mean"</span>].to_numpy()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(start <span class="op">=</span> data[<span class="st">"date"</span>].<span class="bu">min</span>(), periods <span class="op">=</span> <span class="bu">len</span>(rw_states), freq<span class="op">=</span><span class="st">'7D'</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#p = plot_function(dates, np.exp(rw_states), "Estimated Random Walk Component", "Date", "Sales") # to-do: add uncertainty bands</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>df_1 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: date_range, <span class="st">'y'</span>: growth_plus_rw<span class="op">*</span>scale_factor, <span class="st">'var'</span>: <span class="st">'Simulated Trend + Random Walk'</span> })</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>df_2 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: dates, <span class="st">'y'</span>: np.exp(rw_states), <span class="st">'var'</span>: <span class="st">'Estimated Trend + Random Walk'</span> })</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.concat([df_1, df_2])</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> ggplot(df, aes(<span class="st">"x"</span>, <span class="st">"y"</span>, color <span class="op">=</span> <span class="st">"var"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> theme_bw() <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">'top'</span>) <span class="op">+</span> guides(color<span class="op">=</span>guide_legend(title<span class="op">=</span><span class="st">""</span>))</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> p.draw(show<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="day-of-the-week-effects" class="level4"><h4 class="anchored" data-anchor-id="day-of-the-week-effects">2.3.2 Day of the Week Effects</h4>
<ul>
<li>The model appears to correctly identifies weekly sales fluctuations.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>coefs_wday <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"wday_coefficients"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">coefs_wday</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>wday_effect <span class="op">=</span> jnp.dot(model_arguments[<span class="st">"contrasts_wday"</span>], jnp.array(coefs_wday[<span class="st">"mean"</span>]))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_function(<span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">7</span>), wday_effect, <span class="st">"Effect of Day of the Week"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>) <span class="co"># to-do: add uncertainty bands</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>df_1 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: <span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">7</span>), <span class="st">'y'</span>: weekly_seasonality <span class="op">-</span> np.mean(weekly_seasonality), <span class="st">'var'</span>: <span class="st">'Simulated Weekly Seasonality'</span> })</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>df_2 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: <span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">7</span>), <span class="st">'y'</span>: wday_effect.tolist(), <span class="st">'var'</span>: <span class="st">'Estimated Weekly Seasonality'</span> })</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.concat([df_1, df_2])</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> ggplot(df, aes(<span class="st">"x"</span>, <span class="st">"y"</span>, color <span class="op">=</span> <span class="st">"var"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> theme_bw() <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">'top'</span>) <span class="op">+</span> guides(color<span class="op">=</span>guide_legend(title<span class="op">=</span><span class="st">""</span>))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> p.draw(show<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="yearly-seasonality-effects" class="level4"><h4 class="anchored" data-anchor-id="yearly-seasonality-effects">2.3.3 Yearly Seasonality Effects</h4>
<ul>
<li>Seasonal peaks and troughs are largely accurately captured, with minor deviations.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>coefs_yday <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"yday_coefficients"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">coefs_yday</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>yday_effect <span class="op">=</span> jnp.dot(model_arguments[<span class="st">"contrasts_yday"</span>], jnp.array(coefs_yday[<span class="st">"mean"</span>]))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#p = plot_function(data["date"], yday_effect, "Yearly Seasonality", "Date", "Sales") # to-do: add uncertainty bands</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>df_1 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: date_range, <span class="st">'y'</span>: yearly_seasonality <span class="op">-</span> np.mean(yearly_seasonality), <span class="st">'var'</span>: <span class="st">'Simulated Yearly Seasonality'</span> }).with_columns(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"x"</span>).cast(pl.Date)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>df_2 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: data[<span class="st">"date"</span>].tolist(), <span class="st">'y'</span>: yday_effect.tolist(), <span class="st">'var'</span>: <span class="st">'Estimated Yearly Seasonality'</span> })</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.concat([df_1, df_2])</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> ggplot(df, aes(<span class="st">"x"</span>, <span class="st">"y"</span>, color <span class="op">=</span> <span class="st">"var"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> theme_bw() <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">'top'</span>) <span class="op">+</span> guides(color<span class="op">=</span>guide_legend(title<span class="op">=</span><span class="st">""</span>))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> p.draw(show<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="price-elasticity" class="level4"><h4 class="anchored" data-anchor-id="price-elasticity">2.3.4 Price Elasticity</h4>
<ul>
<li>The estimated elasticity coefficient is close enough to the true value (<span class="math inline">\(-1.4\)</span>), though the <span class="math inline">\(94\%\)</span> credible interval is quite wide.</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"elasticity"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">py</span><span class="op">$</span><span class="va">summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section></section><section id="conclusion" class="level2"><h2 class="anchored" data-anchor-id="conclusion">3. Conclusion</h2>
<p>This case study demonstrates how Bayesian modeling can effectively decompose sales variance into meaningful components, providing a structured way to analyze the underlying factors driving sales fluctuations. By applying this approach to a synthetic dataset, we validated the model’s ability to separate out long-term growth, seasonal effects, and price sensitivity while simultaneously quantifying uncertainty.</p>
<p>The key takeaways include:</p>
<ul>
<li><p><strong>Decomposing complexity:</strong> The model successfully isolates different components influencing sales, making it easier to interpret real-world dynamics.</p></li>
<li><p><strong>Quantifying uncertainty:</strong> In addition to point estimates, Bayesian inference provides full posterior distributions, enabling better risk assessment.</p></li>
<li><p><strong>Informed decision-making:</strong> By accounting for all sources of variance, businesses can make more confident strategic decisions that explicitly consider uncertainty. For instance, price optimization can be performed on the entire posterior distribution of the estimate of the price elasticity of demand.</p></li>
</ul>
<p>These findings highlight the advantages of probabilistic modeling in sales analysis, offering a flexible and interpretable method.</p>


<!-- -->

</section></section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/plogacev\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Bayesian Analysis of Sales"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Pavel Logačev"</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "r Sys.Date()"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bayesian Analysis of Sales</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>This notebook demonstrates the use of Bayesian inference for sales forecasting using various probabilistic programming techniques. We will use the <span class="in">`numpyro`</span> library to define and fit our models, and <span class="in">`plotnine`</span> for visualization.</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>Bayesian inference allows us to incorporate prior knowledge and quantify uncertainty in our predictions. This notebook will guide you through the process of building a Bayesian model for sales forecasting, fitting the model using Markov Chain Monte Carlo (MCMC) and Stochastic Variational Inference (SVI), and visualizing the results.</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="fu">## Import Required Libraries And Define Functions</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Set XLA_FLAGS before JAX is imported</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"XLA_FLAGS"</span>] <span class="op">=</span> <span class="st">"--xla_force_host_platform_device_count=8"</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> ggplot, aes, geom_point, geom_line, labs, theme_minimal, theme_bw, scale_x_continuous, scale_x_discrete, scale_x_datetime</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> patsy</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.random <span class="im">as</span> random</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.scipy.special <span class="im">import</span> expit, logit</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro.distributions <span class="im">as</span> dist</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="co">#from numpyro.infer import SVI, Trace_ELBO, Predictive</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer <span class="im">import</span> MCMC, NUTS, MCMC, NUTS <span class="co">#, SVI, Trace_ELBO</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> theme, guides, guide_legend</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="co">#jax.config.update("jax_enable_x64", True)  # Enable float64 by default</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. Model</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>In this section, we define the Bayesian model used for sales forecasting. The model incorporates various components such as random walk for the latent state, day-of-the-week effects, day-of-the-year effects, and price elasticity. The model is implemented using the <span class="in">`numpyro`</span> library, which allows for efficient and scalable Bayesian inference.</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.1 Auxiliary Functions</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>These auxiliary functions are essential for data preprocessing and transformation:</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`periodic_rbf`</span>: Computes a periodic Gaussian radial basis function (RBF).</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`compute_doy_basis`</span>: Computes 12 periodic Gaussian basis functions for seasonal effects.</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`read_data`</span>: Reads and preprocesses the sales data from a CSV file.</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`init_values`</span>: Initializes values for the model parameters.</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a periodic Gaussian radial basis function (RBF)</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> periodic_rbf(x, mu, sigma):</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes a periodic Gaussian radial basis function (RBF).</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="co">        x: Scaled day-of-year values (range [0,1]).</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="co">        mu: Center of the Gaussian basis function.</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="co">        sigma: Controls the spread of the Gaussian.</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="co">        RBF values preserving periodicity.</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute cyclic distance to mu</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    periodic_distance <span class="op">=</span> jnp.minimum(jnp.<span class="bu">abs</span>(x <span class="op">-</span> mu), <span class="dv">1</span> <span class="op">-</span> jnp.<span class="bu">abs</span>(x <span class="op">-</span> mu))</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute RBF value</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jnp.exp(<span class="op">-</span> (periodic_distance <span class="op">**</span> <span class="dv">2</span>) <span class="op">/</span> (<span class="dv">2</span> <span class="op">*</span> sigma <span class="op">**</span> <span class="dv">2</span>))</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_doy_basis(yday_fraction, sigma <span class="op">=</span> <span class="dv">30</span><span class="op">/</span><span class="fl">365.25</span>, n_centers <span class="op">=</span> <span class="dv">12</span>):</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes 12 periodic Gaussian basis functions for seasonal effects.</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a><span class="co">        yday_fraction: Normalized day of the year (range [0,1]).</span></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a><span class="co">        yday_factor: Scaling factor for basis function width.</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="co">        A JAX array with 12 columns representing the 12 monthly basis functions.</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define centers of Gaussian basis functions</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    month_centers <span class="op">=</span> jnp.linspace( <span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>n_centers), <span class="dv">1</span><span class="op">-</span><span class="dv">1</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>n_centers), n_centers)</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate an array of shape (length of input, 12) with the RBF values</span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    doy_basis <span class="op">=</span> jnp.stack([periodic_rbf(yday_fraction, mu, sigma) <span class="cf">for</span> mu <span class="kw">in</span> month_centers], axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subtract each row's mean to enforce sum-to-zero constraint</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    doy_basis_centered <span class="op">=</span> doy_basis <span class="op">-</span> jnp.mean(doy_basis, axis<span class="op">=-</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> doy_basis_centered</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_data(fname, n_rows<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a><span class="co">    Reads and preprocesses the sales data from a CSV file.</span></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a><span class="co">        fname: The filename of the CSV file containing the sales data.</span></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a><span class="co">        A dictionary with the following keys:</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a><span class="co">            - sales: An array of sales data.</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a><span class="co">            - log_price: An array of log-transformed prices.</span></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a><span class="co">            - wday: An array of day-of-the-week values.</span></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a><span class="co">            - yday_fraction: An array of normalized day-of-the-year values.</span></span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the CSV file using polars</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pl.read_csv(fname)</span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only the first n_rows if specified</span></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_rows <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.head(n_rows)</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the 'date' column to date type</span></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.with_columns(pl.col(<span class="st">"date"</span>).<span class="bu">str</span>.to_date())</span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract sales, and log price data as a numpy arrays</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>    sales <span class="op">=</span> df[<span class="st">"sales"</span>].to_numpy()</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>    log_price <span class="op">=</span> df[<span class="st">"log_price"</span>].to_numpy()</span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract day-of-the-week values</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>    wday <span class="op">=</span> df[<span class="st">"date"</span>].dt.weekday().to_numpy() <span class="co"># set offset to 0</span></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract day-of-the-year values</span></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>    yday <span class="op">=</span> df[<span class="st">"date"</span>].dt.ordinal_day().to_numpy()</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine if the year is a leap year</span></span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>    is_leap_year <span class="op">=</span> df[<span class="st">"date"</span>].dt.is_leap_year().to_numpy()</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize day-of-the-year values</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>    yday_fraction <span class="op">=</span> yday <span class="op">/</span> (<span class="dv">365</span> <span class="op">+</span> is_leap_year)</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the preprocessed data as a dictionary</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: df[<span class="st">"date"</span>].to_numpy(),</span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sales"</span>: sales,</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_price"</span>: log_price,</span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wday"</span>: wday,</span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yday_fraction"</span>: yday_fraction</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> interpolate(x, downsampling_factor, n_out):</span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>    idx_n_weight <span class="op">=</span> jnp.array(<span class="bu">range</span>(<span class="dv">0</span>, n_out))<span class="op">/</span>jnp.float64(downsampling_factor)</span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>    idx_1 <span class="op">=</span> jnp.array( jnp.floor(idx_n_weight), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>    idx_2 <span class="op">=</span> jnp.array( jnp.ceil(idx_n_weight), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>    weight_2 <span class="op">=</span> idx_n_weight <span class="op">-</span> idx_1</span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>    state_before <span class="op">=</span> x[idx_1]</span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>    state_after  <span class="op">=</span> x[idx_2]</span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="dv">1</span><span class="op">-</span>weight_2)<span class="op">*</span>state_before <span class="op">+</span> weight_2<span class="op">*</span>state_after</span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunked_mean(x, n_chunk):</span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> x.shape[<span class="dv">0</span>]</span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a>    pad_size <span class="op">=</span> <span class="op">-</span>n <span class="op">%</span> n_chunk <span class="co"># compute padding needed to make k a multiple of n</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a>    x_padded <span class="op">=</span> jnp.pad(array <span class="op">=</span> x, pad_width <span class="op">=</span> (<span class="dv">0</span>, pad_size), mode <span class="op">=</span> <span class="st">'edge'</span>) <span class="co"># pad at the end</span></span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_padded.reshape(<span class="op">-</span><span class="dv">1</span>, n_chunk).mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunked_sum(x, n_chunk):</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> x.shape[<span class="dv">0</span>]</span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>    pad_size <span class="op">=</span> <span class="op">-</span>n <span class="op">%</span> n_chunk <span class="co"># compute padding needed to make k a multiple of n</span></span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a>    x_padded <span class="op">=</span> jnp.pad(array <span class="op">=</span> x, pad_width <span class="op">=</span> (<span class="dv">0</span>, pad_size)) <span class="co"># pad at the end</span></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_padded.reshape(<span class="op">-</span><span class="dv">1</span>, n_chunk).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a simple plot using plotnine</span></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_function(x, y, title, xlab, ylab):</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert x to numpy array</span></span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.array(x)</span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if y is a callable function</span></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">callable</span>(y):</span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If y is a function, apply it to x and create a DataFrame</span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame({<span class="st">"x"</span>: x, <span class="st">"y"</span>: y(x)})</span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If y is not a function, create a DataFrame directly</span></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.DataFrame({<span class="st">"x"</span>: x, <span class="st">"y"</span>: y})        </span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the plot using ggplot</span></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a>    plot <span class="op">=</span> (ggplot(df, aes(x<span class="op">=</span><span class="st">"x"</span>, y<span class="op">=</span><span class="st">"y"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> labs(title<span class="op">=</span>title, x<span class="op">=</span>xlab, y<span class="op">=</span>ylab) <span class="op">+</span> theme_bw())</span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the plot</span></span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> plot</span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.2 Model</span></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1.2.1 Key Features</span></span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sales are modeled using a **stochastic Poisson process**, where the expected rate $\lambda_t$ evolves over time.</span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **latent sales rate** follows a random walk, allowing it to drift nonstationarily.</span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Seasonal components** (day-of-the-week and annual patterns) adjust for structured demand variations.</span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Price elasticity** is explicitly modeled, ensuring sensitivity to pricing dynamics.</span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The model is implemented in numpyro, enabling scalable Bayesian inference.</span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 1.2.1 Model Overview</span></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a>We model the sales time series as a **stochastic process** where the underlying rate of sales evolves over time. This evolution follows a **random walk structure**, but with systematic adjustments for covariates such as price, day-of-the-week effects, and day-of-the-year effects. The rate of sales $\lambda_t$ on day $t$ is a function of captures *(i)* systematic covariate effects ($z_t$), *(ii)*</span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>a global baseline ($\mu_\tau$), and *(iii)* the latent dynamic component ($\tau_t$).</span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a>log~\lambda_t = z_t + \mu_\tau + \tau_t</span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 1.2.1.1 Latent States Dynamics</span></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a>The baseline sales level $\tau_t$ follows a **random walk**. Because all contrast matrices for structured effects are centered, $\mu_\tau + \tau_t$ can be interpreted as the average latent sales rate on $\tau_t$. </span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a>\tau_t = \tau_{t-1} + \delta_t, \quad \delta_t \sim \mathcal{N}(0, \sigma_\tau)</span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>with:</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a>\mu_\tau \sim \text{Exponential}(1), \quad \sigma_\tau \sim \mathcal{N}(1)</span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 1.2.1.2 Structured Effects</span></span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>We further accounted for systematic effects of *(i)* day of the week, *(ii)* day of the year, and *(iii)* price.</span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For day of the week effects, we used a contrast matrix $\mathbf{C}_{\text{wday}}$ with sliding differences.</span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>For day of the year effects, we used a matrix of Gaussian radial basis functions $\mathbf{B}_{\text{yday}}$.</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Price elasticity is modelled using a centered log price </span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a>Similarly, the day-of-the-year effects are modeled using a seasonality basis matrix $\mathbf{B}_{\text{yday}}$, which represents periodic seasonal patterns using Gaussian radial basis functions (RBFs).</span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Day-of-the-week effects**:</span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>  zw_t = \mathbf{C}_{\text{wday}} \cdot \beta_{\text{wday}}, \quad \beta_{\text{wday}} \sim \mathcal{N}(0, 1)</span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Day-of-the-year effects**:</span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a>  zy_t = \mathbf{B}_{\text{yday}} \cdot \beta_{\text{yday}}, \quad \beta_{\text{yday}} \sim \mathcal{N}(0, 1)</span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Price elasticity**:</span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a>  ze_t = \text{log<span class="sc">\_</span>price<span class="sc">\_</span>centered} \cdot e, \quad \log(-e) \sim \mathcal{N^{+}}(0, 1)</span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Sum of structural effects**:</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a>  z_t = zw_t + zy_t + ze_t</span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 1.2.1.3 Emissions Model</span></span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a>Observed sales are assumed to follow a **Poisson distribution**, ensuring discrete, non-negative observations:</span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a>S_t \sim \text{Poisson}(\lambda_t)</span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_local_level_poisson(sales: jnp.array, log_price_centered: jnp.array, wday: jnp.array, yday_fraction: jnp.array, </span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a>                              contrasts_sdif_t: jnp.array, contrasts_wday: jnp.array, contrasts_yday: jnp.array, </span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a>                              downsampling_factor <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="op">=</span> <span class="bu">len</span>(sales)</span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a>    n_states <span class="op">=</span> contrasts_sdif_t.shape[<span class="dv">0</span>]</span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_random_walk(contrasts_sdif_t, n_states):</span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a>        log_sigma <span class="op">=</span> numpyro.sample(<span class="st">"log_sigma"</span>, dist.Gumbel(<span class="dv">0</span>, <span class="dv">5</span>))</span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> numpyro.deterministic(<span class="st">"sigma"</span>, jnp.exp(log_sigma))</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a>        log_state_mean <span class="op">=</span> numpyro.sample(<span class="st">"log_state_mean"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">5</span>)) <span class="co"># to-do: add an average drift term, as well as potentially an additional parameter governing drift dynamics </span></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a>        log_state_delta <span class="op">=</span> numpyro.sample( <span class="st">"log_state_delta"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">1</span>), sample_shape<span class="op">=</span>(n_states<span class="op">-</span><span class="dv">1</span>,))</span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> numpyro.deterministic(<span class="st">"log_state_base"</span>, jnp.dot(contrasts_sdif_t, log_state_delta) <span class="op">*</span> sigma <span class="op">+</span> log_state_mean )</span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> log_state_base</span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_downsampled_random_walk(contrasts_sdif_t, n_obs, n_states):</span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a>        log_state_base_downsampled <span class="op">=</span> sample_random_walk(contrasts_sdif_t, n_states)</span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> interpolate(log_state_base_downsampled, downsampling_factor, n_obs)</span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> log_state_base</span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_wday_effect(contrasts_wday, wday):</span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior for day-of-the-week effects (6 coefficients)</span></span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a>        wday_coefficients <span class="op">=</span> numpyro.sample(<span class="st">"wday_coefficients"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">1</span>), sample_shape<span class="op">=</span>(<span class="dv">6</span>,))</span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute wday effect per observation (sum-to-zero constraint applied via contrasts)</span></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>        wday_effects <span class="op">=</span> jnp.dot(contrasts_wday, wday_coefficients)</span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jnp.array(wday_effects[wday<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_yday_effect(contrasts_yday, yday_fraction):</span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior for yearly seasonality effects (12 coefficients)</span></span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a>        yday_coefficients <span class="op">=</span> numpyro.sample(<span class="st">"yday_coefficients"</span>, dist.Normal(<span class="dv">0</span>, <span class="dv">1</span>), sample_shape<span class="op">=</span>(<span class="dv">12</span>,))</span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> jnp.dot(contrasts_yday, yday_coefficients)</span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sample_price_effect(log_price_centered):</span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prior for price elasticity</span></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a>        elasticity_pos <span class="op">=</span> numpyro.sample( <span class="st">"elasticity_pos"</span>, dist.HalfNormal(<span class="dv">10</span>) )</span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a>        elasticity <span class="op">=</span> numpyro.deterministic(<span class="st">"elasticity"</span>, <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> elasticity_pos)</span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> log_price_centered <span class="op">*</span> elasticity</span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample random walk    </span></span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_obs <span class="op">==</span> n_states:</span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> sample_random_walk(contrasts_sdif_t, n_states)</span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a>        log_state_base <span class="op">=</span> sample_downsampled_random_walk(contrasts_sdif_t, n_obs, n_states)</span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample day-of-the-week effects</span></span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>    wday_effect <span class="op">=</span> sample_wday_effect(contrasts_wday, wday)</span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample day-of-the-year effects</span></span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a>    yday_effect <span class="op">=</span> sample_yday_effect(contrasts_yday, yday_fraction)</span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample elasticity effect</span></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a>    price_effect <span class="op">=</span> sample_price_effect(log_price_centered)</span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute state</span></span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> numpyro.deterministic(<span class="st">"state"</span>, jnp.exp( log_state_base  <span class="op">+</span> yday_effect <span class="op">+</span> wday_effect <span class="op">+</span> price_effect )) <span class="co">#   # </span></span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute log-likelihood for poisson emissions</span></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a>    numpyro.sample(<span class="st">"sales"</span>, dist.Poisson(rate<span class="op">=</span>state), obs<span class="op">=</span>sales) <span class="co"># to-do: create a Poisson distribution paramaterized by log-rate, as in the Stan manual </span></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2. Fit the Model </span></span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a>We use the <span class="in">`run_nuts`</span> function to fit the model to our sales data. The function leverages the No-U-Turn Sampler (NUTS) from the <span class="in">`numpyro`</span> library to perform MCMC sampling.</span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>Because the model has a large number of latent parameters, initialization to sensible start values is key.</span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.1 Model Fitting Logic</span></span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a>In order to fit the model, the functions below are used:</span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span><span class="in">`prepare_model_arguments`</span>: Transforms the data into a format required by the model, including sales data, log-transformed prices, day-of-the-week values, and normalized day-of-the-year values.</span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span><span class="in">`init_values`</span>: Finds sensible start values for the model parameters which, in this case is crucial for the convergence of the MCMC algorithm.</span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span><span class="in">`run_nuts`</span>: Given a dataset, it calls the NUTS sampler to perform MCMC sampling.</span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_values(sales: jnp.array, log_price_centered: jnp.array, wday, yday_fraction: jnp.array, downsampling_factor <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a>    epsilon <span class="op">=</span> <span class="fl">0.001</span></span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a>    log_state_est <span class="op">=</span> jnp.log(sales <span class="op">+</span> epsilon)</span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a>    log_state_mean_est <span class="op">=</span> jnp.mean(log_state_est)</span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>    log_state_delta_est <span class="op">=</span> jnp.diff(log_state_est)</span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> downsampling_factor <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>        log_state_delta_est <span class="op">=</span> chunked_sum(log_state_delta_est, downsampling_factor)</span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a>    log_state_delta_sd_est <span class="op">=</span> jnp.std(log_state_delta_est)</span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_sigma"</span>: jnp.log( log_state_delta_sd_est ),</span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_state_mean"</span>: log_state_mean_est,</span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_state_delta"</span>: log_state_delta_est,</span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a>        <span class="st">"wday_coefficients"</span>: jnp.array([<span class="fl">0.0</span>]<span class="op">*</span><span class="dv">6</span>),</span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a>        <span class="st">"yday_coefficients"</span>: jnp.array([<span class="fl">0.0</span>]<span class="op">*</span><span class="dv">12</span>),</span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_elasticity"</span>: jnp.array([<span class="fl">0.0</span>])</span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_model_arguments(sales: jnp.array, log_price: jnp.array, wday: jnp.array, yday_fraction: jnp.array, downsampling_factor <span class="op">=</span> <span class="dv">1</span>):</span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" </span></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepares the arguments required for the model.</span></span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a><span class="co">        sales: Array of sales data.</span></span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a><span class="co">        log_price: Array of log-transformed prices.</span></span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a><span class="co">        wday: Array of day-of-the-week values.</span></span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a><span class="co">        yday_fraction: Array of normalized day-of-the-year values.</span></span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a><span class="co">        downsampling_factor: Factor by which to downsample the data.</span></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a><span class="co">        A tuple containing initialized values for the model parameters and the model arguments.</span></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span>    </span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="op">=</span> <span class="bu">len</span>(sales)</span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the number of states based on the downsampling factor</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> downsampling_factor <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a>        n_states <span class="op">=</span> n_obs</span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>        n_states <span class="op">=</span> <span class="bu">int</span>(np.ceil(n_obs <span class="op">/</span> downsampling_factor) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define contrast matrix for random walk (T coefficients, sum-to-zero constraint)</span></span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a>    contrasts_sdif_t <span class="op">=</span> patsy.contrasts.Diff().code_without_intercept(<span class="bu">range</span>(<span class="dv">0</span>, n_states)).matrix</span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define contrast matrix for day-of-the-week effects (6 coefficients, sum-to-zero constraint)</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>    contrasts_wday <span class="op">=</span> patsy.contrasts.Diff().code_without_intercept(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">7</span>)).matrix  <span class="co"># 7 days → 6 contrasts</span></span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute yday effect per observation (sum-to-zero constraint applied via contrasts)</span></span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>    contrasts_yday <span class="op">=</span> compute_doy_basis(yday_fraction, sigma<span class="op">=</span><span class="dv">30</span><span class="op">/</span><span class="fl">365.25</span>, n_centers<span class="op">=</span><span class="dv">12</span>) <span class="co"># to-do: do a very approximate calibration of the RBF width parameter sigma, using something like a spline for the long term trend + RBF seasonality</span></span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute centered log price differences</span></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>    log_price_centered <span class="op">=</span> log_price <span class="op">-</span> jnp.mean(log_price)</span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set up the model parameters</span></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a>    model_arguments <span class="op">=</span> {</span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sales'</span>: sales,</span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a>        <span class="st">'log_price_centered'</span>: log_price_centered,</span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a>        <span class="st">'wday'</span>: jnp.array(wday, dtype<span class="op">=</span><span class="bu">int</span>),</span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>        <span class="st">'yday_fraction'</span>: yday_fraction,</span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a>        <span class="st">'downsampling_factor'</span>: downsampling_factor,</span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contrasts_sdif_t'</span>: contrasts_sdif_t,</span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contrasts_wday'</span>: contrasts_wday,</span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a>        <span class="st">'contrasts_yday'</span>: contrasts_yday</span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare initial values for parameters </span></span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a>    init_params <span class="op">=</span> init_values(sales, log_price_centered, wday, yday_fraction, downsampling_factor)</span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> init_params, model_arguments</span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_nuts(sales: jnp.array, log_price: jnp.array, wday, yday_fraction: jnp.array, downsampling_factor <span class="op">=</span> <span class="dv">1</span>, n_chains <span class="op">=</span> <span class="dv">1</span>, num_warmup<span class="op">=</span><span class="dv">1_000</span>, num_samples<span class="op">=</span><span class="dv">1_000</span>, step_size<span class="op">=</span><span class="fl">0.01</span>, max_tree_depth<span class="op">=</span><span class="dv">8</span>):</span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Runs NUTS MCMC inference on the model </span></span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize random number generator key</span></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a>    rng_key <span class="op">=</span> random.PRNGKey(<span class="dv">0</span>)</span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the number of observations</span></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="op">=</span> <span class="bu">len</span>(sales)</span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare model arguments and initial parameter values</span></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>    init_params, model_arguments <span class="op">=</span> prepare_model_arguments(sales <span class="op">=</span> sales, log_price <span class="op">=</span> log_price, wday <span class="op">=</span> wday, yday_fraction <span class="op">=</span> yday_fraction, downsampling_factor <span class="op">=</span> downsampling_factor)</span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split the random number generator key</span></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>    rng_key, rng_key_ <span class="op">=</span> random.split(rng_key)</span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the number of chains for parallel sampling</span></span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a>    numpyro.set_host_device_count(n_chains)</span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the model to be used</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a>    reparam_model <span class="op">=</span> model_local_level_poisson</span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the NUTS kernel with the specified step size and tree depth</span></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>    kernel <span class="op">=</span> NUTS(reparam_model, step_size<span class="op">=</span>step_size, max_tree_depth<span class="op">=</span>max_tree_depth)</span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize the MCMC sampler with the NUTS kernel</span></span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a>    mcmc <span class="op">=</span> MCMC(kernel, num_warmup<span class="op">=</span>num_warmup, num_samples<span class="op">=</span>num_samples, num_chains<span class="op">=</span>n_chains)</span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run the MCMC sampler</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a>    mcmc.run(rng_key_, <span class="op">**</span>model_arguments) <span class="co"># disable init values: init_params=init_params</span></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the fitted MCMC object</span></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mcmc, model_arguments</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.2 Fit the Model to the Synthetic Dataset</span></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>We fit the model to the synthetic dataset using the <span class="in">`run_nuts`</span> function. The model is fitted using the No-U-Turn Sampler (NUTS) from the <span class="in">`numpyro`</span> library, with 4 chains, 1,000 warmup iterations, and 1,000 sampling iterations. The step size is set to 0.01, and the maximum tree depth is 8. The fitted model is stored in the <span class="in">`m_fit`</span> variable.</span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>On CPU, the process takes about 2 minutes.</span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a><span class="co"># read in the synthetic sales data</span></span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> read_data(<span class="st">"sales_synthetic.csv"</span>)</span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"sim_parameters.pkl"</span>, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>    sim_parameters <span class="op">=</span> date_range, growth, growth_plus_rw, scale_factor, wday, weekly_seasonality, yearly_seasonality <span class="op">=</span> pickle.load(f)</span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model using NumPyro NUTS MCMC</span></span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a>m_fit, model_arguments <span class="op">=</span> run_nuts(data[<span class="st">'sales'</span>], data[<span class="st">'log_price'</span>], data[<span class="st">'wday'</span>], data[<span class="st">'yday_fraction'</span>], </span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>                                    downsampling_factor<span class="op">=</span><span class="dv">7</span>, n_chains<span class="op">=</span><span class="dv">4</span>, num_warmup<span class="op">=</span><span class="dv">1_000</span>, num_samples<span class="op">=</span><span class="dv">1_000</span>,</span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a>                                    step_size<span class="op">=</span><span class="fl">0.01</span>, max_tree_depth<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.3 Inspect the MCMC results</span></span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>All effective sample sizes are decent, which is a good sign. The Gelman-Rubin statistics are close to 1, indicating convergence. Inspection of trace plots are beyond the scope of this notebook.</span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The model successfully reconstructs all key features of the synthetic dataset.</span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.3.1 Random Walk Component</span></span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The estimated random walk component closely follows the true trajectory of the combination long-term trend + random fluctuations in the synthetic data.  </span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's look at the estimated random walk component of the model.</span></span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"sigma"</span>, <span class="st">"log_state_delta"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)</span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>summary</span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Here, we'll plot the estimated the random walk component, which also incorporates long term trends and growth or decline of sales. For present purposes, this is what amounts to irrelevant noise in the model.</span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: thumbnail-image</span></span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sequence of dates starting at data["date"].min() the length of x['mean'], in steps of 7 days</span></span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a>rw_states <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"log_state_base"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)[<span class="st">"mean"</span>].to_numpy()</span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> pd.date_range(start <span class="op">=</span> data[<span class="st">"date"</span>].<span class="bu">min</span>(), periods <span class="op">=</span> <span class="bu">len</span>(rw_states), freq<span class="op">=</span><span class="st">'7D'</span>)</span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a><span class="co">#p = plot_function(dates, np.exp(rw_states), "Estimated Random Walk Component", "Date", "Sales") # to-do: add uncertainty bands</span></span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>df_1 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: date_range, <span class="st">'y'</span>: growth_plus_rw<span class="op">*</span>scale_factor, <span class="st">'var'</span>: <span class="st">'Simulated Trend + Random Walk'</span> })</span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>df_2 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: dates, <span class="st">'y'</span>: np.exp(rw_states), <span class="st">'var'</span>: <span class="st">'Estimated Trend + Random Walk'</span> })</span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.concat([df_1, df_2])</span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> ggplot(df, aes(<span class="st">"x"</span>, <span class="st">"y"</span>, color <span class="op">=</span> <span class="st">"var"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> theme_bw() <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">'top'</span>) <span class="op">+</span> guides(color<span class="op">=</span>guide_legend(title<span class="op">=</span><span class="st">""</span>))</span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> p.draw(show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.3.2 Day of the Week Effects</span></span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The model appears to correctly identifies weekly sales fluctuations.</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-578"><a href="#cb24-578" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-579"><a href="#cb24-579" aria-hidden="true" tabindex="-1"></a>coefs_wday <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"wday_coefficients"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)</span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-584"><a href="#cb24-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>coefs_wday</span>
<span id="cb24-586"><a href="#cb24-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-587"><a href="#cb24-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a>wday_effect <span class="op">=</span> jnp.dot(model_arguments[<span class="st">"contrasts_wday"</span>], jnp.array(coefs_wday[<span class="st">"mean"</span>]))</span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_function(<span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">7</span>), wday_effect, <span class="st">"Effect of Day of the Week"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>) <span class="co"># to-do: add uncertainty bands</span></span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a>df_1 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: <span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">7</span>), <span class="st">'y'</span>: weekly_seasonality <span class="op">-</span> np.mean(weekly_seasonality), <span class="st">'var'</span>: <span class="st">'Simulated Weekly Seasonality'</span> })</span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a>df_2 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: <span class="bu">range</span>(<span class="dv">0</span>,<span class="dv">7</span>), <span class="st">'y'</span>: wday_effect.tolist(), <span class="st">'var'</span>: <span class="st">'Estimated Weekly Seasonality'</span> })</span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.concat([df_1, df_2])</span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> ggplot(df, aes(<span class="st">"x"</span>, <span class="st">"y"</span>, color <span class="op">=</span> <span class="st">"var"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> theme_bw() <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">'top'</span>) <span class="op">+</span> guides(color<span class="op">=</span>guide_legend(title<span class="op">=</span><span class="st">""</span>))</span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> p.draw(show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.3.3 Yearly Seasonality Effects</span></span>
<span id="cb24-604"><a href="#cb24-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-605"><a href="#cb24-605" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Seasonal peaks and troughs are largely accurately captured, with minor deviations.</span>
<span id="cb24-606"><a href="#cb24-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a>coefs_yday <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"yday_coefficients"</span>], filter_vars<span class="op">=</span><span class="st">"like"</span>)</span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>coefs_yday</span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a>yday_effect <span class="op">=</span> jnp.dot(model_arguments[<span class="st">"contrasts_yday"</span>], jnp.array(coefs_yday[<span class="st">"mean"</span>]))</span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a><span class="co">#p = plot_function(data["date"], yday_effect, "Yearly Seasonality", "Date", "Sales") # to-do: add uncertainty bands</span></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a>df_1 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: date_range, <span class="st">'y'</span>: yearly_seasonality <span class="op">-</span> np.mean(yearly_seasonality), <span class="st">'var'</span>: <span class="st">'Simulated Yearly Seasonality'</span> }).with_columns(</span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"x"</span>).cast(pl.Date)</span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a>df_2 <span class="op">=</span> pl.DataFrame({<span class="st">'x'</span>: data[<span class="st">"date"</span>].tolist(), <span class="st">'y'</span>: yday_effect.tolist(), <span class="st">'var'</span>: <span class="st">'Estimated Yearly Seasonality'</span> })</span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pl.concat([df_1, df_2])</span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-632"><a href="#cb24-632" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> ggplot(df, aes(<span class="st">"x"</span>, <span class="st">"y"</span>, color <span class="op">=</span> <span class="st">"var"</span>)) <span class="op">+</span> geom_line() <span class="op">+</span> theme_bw() <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">'top'</span>) <span class="op">+</span> guides(color<span class="op">=</span>guide_legend(title<span class="op">=</span><span class="st">""</span>))</span>
<span id="cb24-633"><a href="#cb24-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> p.draw(show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 2.3.4 Price Elasticity</span></span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The estimated elasticity coefficient is close enough to the true value ($-1.4$), though the $94\%$ credible interval is quite wide.</span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> az.summary(m_fit, var_names<span class="op">=</span>[<span class="st">"elasticity"</span>])</span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a>py<span class="sc">$</span>summary</span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3. Conclusion</span></span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-657"><a href="#cb24-657" aria-hidden="true" tabindex="-1"></a>This case study demonstrates how Bayesian modeling can effectively decompose sales variance into meaningful components, providing a structured way to analyze the underlying factors driving sales fluctuations. By applying this approach to a synthetic dataset, we validated the model’s ability to separate out long-term growth, seasonal effects, and price sensitivity while simultaneously quantifying uncertainty.</span>
<span id="cb24-658"><a href="#cb24-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a>The key takeaways include:</span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Decomposing complexity:** The model successfully isolates different components influencing sales, making it easier to interpret real-world dynamics.</span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Quantifying uncertainty:** In addition to point estimates, Bayesian inference provides full posterior distributions, enabling better risk assessment.</span>
<span id="cb24-664"><a href="#cb24-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-665"><a href="#cb24-665" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Informed decision-making:** By accounting for all sources of variance, businesses can make more confident strategic decisions that explicitly consider uncertainty. For instance, price optimization can be performed on the entire posterior distribution of the estimate of the price elasticity of demand.</span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a>These findings highlight the advantages of probabilistic modeling in sales analysis, offering a flexible and interpretable method.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>