<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Pavel Logačev">

<title>Bayesian Changepoint Detection on Price Histograms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="changepoint_marginal_stan_files/libs/clipboard/clipboard.min.js"></script>
<script src="changepoint_marginal_stan_files/libs/quarto-html/quarto.js"></script>
<script src="changepoint_marginal_stan_files/libs/quarto-html/popper.min.js"></script>
<script src="changepoint_marginal_stan_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="changepoint_marginal_stan_files/libs/quarto-html/anchor.min.js"></script>
<link href="changepoint_marginal_stan_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="changepoint_marginal_stan_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="changepoint_marginal_stan_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="changepoint_marginal_stan_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="changepoint_marginal_stan_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="changepoint_marginal_stan_files/libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="changepoint_marginal_stan_files/libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#summary" id="toc-summary" class="nav-link active" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#data-and-problem-context" id="toc-data-and-problem-context" class="nav-link" data-scroll-target="#data-and-problem-context">Data and Problem Context</a></li>
  <li><a href="#bayesian-changepoint-detection-on-price-histograms" id="toc-bayesian-changepoint-detection-on-price-histograms" class="nav-link" data-scroll-target="#bayesian-changepoint-detection-on-price-histograms">1. Bayesian Changepoint Detection on Price Histograms</a></li>
  <li><a href="#model-architecture" id="toc-model-architecture" class="nav-link" data-scroll-target="#model-architecture">Model Architecture</a>
  <ul class="collapse">
  <li><a href="#prior-on-changepoint-probabilities" id="toc-prior-on-changepoint-probabilities" class="nav-link" data-scroll-target="#prior-on-changepoint-probabilities">1. Prior on Changepoint Probabilities</a></li>
  <li><a href="#marginal-likelihood-via-dynamic-programming" id="toc-marginal-likelihood-via-dynamic-programming" class="nav-link" data-scroll-target="#marginal-likelihood-via-dynamic-programming">2. Marginal Likelihood via Dynamic Programming</a></li>
  <li><a href="#precomputed-segment-log-likelihoods" id="toc-precomputed-segment-log-likelihoods" class="nav-link" data-scroll-target="#precomputed-segment-log-likelihoods">2.1 Precomputed Segment Log-Likelihoods</a></li>
  <li><a href="#dynamic-programming-over-segmentations" id="toc-dynamic-programming-over-segmentations" class="nav-link" data-scroll-target="#dynamic-programming-over-segmentations">2.2 Dynamic Programming over Segmentations</a></li>
  <li><a href="#prior-on-change-magnitudes" id="toc-prior-on-change-magnitudes" class="nav-link" data-scroll-target="#prior-on-change-magnitudes">3. Prior on Change Magnitudes</a></li>
  </ul></li>
  <li><a href="#final-posterior-expression" id="toc-final-posterior-expression" class="nav-link" data-scroll-target="#final-posterior-expression">Final Posterior Expression</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#setup-1" id="toc-setup-1" class="nav-link" data-scroll-target="#setup-1">Setup</a></li>
  <li><a href="#compile-and-run-stan-model" id="toc-compile-and-run-stan-model" class="nav-link" data-scroll-target="#compile-and-run-stan-model">Compile and Run Stan Model</a></li>
  <li><a href="#analyze-estimated-changepoint-probabilities" id="toc-analyze-estimated-changepoint-probabilities" class="nav-link" data-scroll-target="#analyze-estimated-changepoint-probabilities">Analyze Estimated Changepoint Probabilities</a></li>
  <li><a href="#inspect-model-internals" id="toc-inspect-model-internals" class="nav-link" data-scroll-target="#inspect-model-internals">Inspect Model Internals</a>
  <ul class="collapse">
  <li><a href="#inspect-change-priors" id="toc-inspect-change-priors" class="nav-link" data-scroll-target="#inspect-change-priors">Inspect Change Priors</a></li>
  </ul></li>
  <li><a href="#remarks-and-next-steps" id="toc-remarks-and-next-steps" class="nav-link" data-scroll-target="#remarks-and-next-steps">Remarks and Next Steps</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Bayesian Changepoint Detection on Price Histograms</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Pavel Logačev </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Invalid Date</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This notebook presents a Bayesian changepoint detection model applied to synthetic sales data, where product prices change over time. The goal is to detect structural changes in pricing behavior based on price histograms over time when the pricing of a product undergoes a meaningful shift — such as promotions, list price changes, or changes in the availability of discounts.</p>
<p>The model determines that based on daily price histograms (i.e., distributions of sold units across different price points). The model is implemented in Stan and designed to serve as a modular component within larger hierarchical models for retail analytics.</p>
<p>The model marginalizes over all possible segmentations of the time series, using a dynamic programming algorithm to recursively compute the total marginal likelihood across all changepoint configurations. It is well-suited for integration in hierarchical settings where multiple products or locations share changepoint structure. This is especially useful when you want to detect coordinated changes across multiple products or stores.</p>
</section>
<section id="data-and-problem-context" class="level2">
<h2 class="anchored" data-anchor-id="data-and-problem-context">Data and Problem Context</h2>
<ul>
<li>Each time point <span class="math inline">\(t\)</span> corresponds to a histogram of prices on that day, recording how many units were sold at each price.</li>
<li>The goal is to identify when the distribution over prices changes in a meaningful way.</li>
<li>In practice, such changes might reflect promotions or price changes.</li>
<li>Because real-world sales data is often sparse and noisy, the model uses probabilistic smoothing over changepoint locations, rather than hard thresholding.</li>
</ul>
<p>We define:</p>
<ul>
<li><span class="math inline">\(y_t\)</span>: the observed <strong>price histogram</strong> at time <span class="math inline">\(t\)</span>, represented as a vector over discretized price bins.</li>
<li><span class="math inline">\(\pi_t \in (0, 1)\)</span>: the <strong>probability of a changepoint</strong> between time <span class="math inline">\(t\)</span> and <span class="math inline">\(t+1\)</span>.</li>
<li><span class="math inline">\(\delta_t\)</span>: the <strong>change magnitude</strong>, defined as the absolute difference in expected price between day <span class="math inline">\(t\)</span> and day <span class="math inline">\(t-1\)</span>, based on histogram means.</li>
<li><span class="math inline">\(\theta\)</span>: parameters governing the prior distribution over <span class="math inline">\(\delta_t\)</span>.</li>
</ul>
</section>
<section id="bayesian-changepoint-detection-on-price-histograms" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-changepoint-detection-on-price-histograms">1. Bayesian Changepoint Detection on Price Histograms</h2>
<p>This model addresses the problem of detecting changepoints in price histograms over time — points where the pricing behavior of a product undergoes a meaningful shift (e.g., due to promotion, repricing, or competitor reaction).</p>
<p>Instead of trying to detect changepoints deterministically or estimating their positions directly, the model marginalizes over all possible segmentations. It does this by:</p>
<ul>
<li>Precomputing the log-likelihood of each possible segment in a time series of price histograms.</li>
<li>Using a prior over changepoints (interpreted as per-time probabilities).</li>
<li>Recursively computing the marginal likelihood of the full sequence with a dynamic programming approach, integrating over all possible changepoint combinations.</li>
</ul>
<p>This setup avoids sampling discrete changepoint positions and is designed to be embedded in a larger hierarchical model. For example, one can later use a common prior across products or sites and detect simultaneous price changes across products.</p>
<p>This method is particularly useful in retail pricing, where:</p>
<ul>
<li>Price change signals are noisy,</li>
<li>Some products change price rarely or erratically,</li>
<li>Detecting simultaneous changes across multiple products reveals coordinated promotions or systemic price shifts.</li>
</ul>
</section>
<section id="model-architecture" class="level2">
<h2 class="anchored" data-anchor-id="model-architecture">Model Architecture</h2>
<p>This model detects changepoints in a time series of price histograms by marginalizing over all possible segmentations in a Bayesian framework.</p>
<p>After each time point <span class="math inline">\(k \in {1, \ldots, T-1}\)</span>, the model assumes that the current price regime either continues or changes. When a regime change occurs after point <span class="math inline">\(k\)</span> (<span class="math inline">\(z_k=1\)</span>), we expect the price distribution to differ meaningfully from the previous one. This difference is governed by a prior over <strong>change magnitudes</strong>, parameterized by <span class="math inline">\(\theta\)</span>. Because Stan does not support discrete latent variables, we analytically marginalize over the binary regime change indicators <span class="math inline">\(z_1:T-1\)</span>, and expresses the model directly in terms of <span class="math inline">\(\pi_1:T-1\)</span>, the parameters governing the probability of a regime change between each pair of time points.</p>
<p>In the complete theoretical model, we would model the distributions associated with the different pricing regimes. However, in practice, doing so requires the estimation of an additional <span class="math inline">\(T \cdot (T-1)/2 \cdot N\)</span> parameters, where <span class="math inline">\(T\)</span> is the number of data points, and <span class="math inline">\(N\)</span> is the number of price points overall. The computational cost of this number of parameters appears prohibitively expensive, which is why the present model is simplified in two points:</p>
<ol type="1">
<li>We do not explicitly model latent price distributions per segment. Instead, we use the observed histogram proportions directly to compute multinomial segment likelihoods.</li>
<li>We apply the change magnitude prior not to the underlying distributional shift, but to the distance between the <strong>first and last observed histograms</strong> in a segment — for instance, via the absolute difference in mean prices.</li>
</ol>
<p>The model’s components:</p>
<ul>
<li><span class="math inline">\(y_k\)</span>: Observed price histogram at time <span class="math inline">\(k\)</span>.</li>
<li><span class="math inline">\(\\pi_k\)</span>: Probability of a changepoint between <span class="math inline">\(k\)</span> and <span class="math inline">\(k+1\)</span>.<br>
<em>(One parameter per time point, total: <span class="math inline">\(T-1\)</span>)</em></li>
<li><span class="math inline">\(\\theta\)</span>: Parameters of the prior on how much the price distribution is expected to change after a regime shift.</li>
</ul>
<p>The posterior is given by:</p>
<p><span class="math display">\[
\underbrace{ p(\pi_{1:T-1}, \theta \mid \mathbf{y}_{1:T}) }_{\textbf{Posterior}}
\propto
\underbrace{ p( \pi_{1:T-1} ) }_{ \text{Changepoint prior} } \cdot
\underbrace{ p( \theta ) }_{ \text{Prior on change magnitude} } \cdot
\underbrace{ p( \mathbf{y}_{1:T} \mid \pi_{1:T-1}, \theta ) }_{
  \substack{
    \text{ Marginal likelihood } \\
    \text{ (multinomial segments, regime-change-weighted) }
  }
}
\]</span></p>
<p>The likelihood term integrates over all possible binary changepoint sequences consistent with the per-day probabilities <span class="math inline">\(\\pi_k\)</span>, weighting each segmentation path by its segment likelihood and its compatibility with the prior over change magnitudes.</p>
<hr>
<p>This model estimates changepoints in time-series histogram data by marginalizing over all possible segmentations using a Bayesian framework. The posterior has three main components, each of which is described below.</p>
<ul>
<li><span class="math inline">\(y_k\)</span>: Price histogram for time point <span class="math inline">\(k\)</span>.</li>
<li><span class="math inline">\(\pi_k\)</span>: Probability of a changepoint between <span class="math inline">\(k\)</span> and <span class="math inline">\(k+1\)</span>. (Total number of parameters: <span class="math inline">\(\text{number of time points} - 1\)</span>)</li>
<li><span class="math inline">\(\theta\)</span>: Parameters for the prior over the change magnitude at the changepoint between <span class="math inline">\(k\)</span> and <span class="math inline">\(k+1\)</span>.</li>
</ul>
<p><span class="math display">\[
\underbrace{ p(\pi_{1:T-1}, \theta_{1:T} \mid \mathbf{y}_{1:T}) }_{Posterior}
  \propto
  \underbrace{ p( \pi_{1:T-1}) }_{\text{Changepoint prob. prior} } \cdot
  \underbrace{ p( \mathbf{y}_{1:T} \mid \pi_{1:T-1}, \theta_{1:T} ) }_{\text{Marginal likelihood}} \cdot
  \underbrace{ p( \theta_{1:T} ) }_{\text{Prior on the change magnitude}}
\]</span></p>
<section id="prior-on-changepoint-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="prior-on-changepoint-probabilities">1. Prior on Changepoint Probabilities</h3>
<p><span class="math display">\[
p(\boldsymbol{\pi}) = \prod_{t=2}^{T} \text{Beta}(\pi_t \mid \alpha, \beta)
\]</span></p>
<ul>
<li>Each <span class="math inline">\(\pi_t \in (0, 1)\)</span> represents the probability of a changepoint at time <span class="math inline">\(t\)</span>.</li>
<li>These are treated as <strong>independent latent variables</strong>, typically with <span class="math inline">\(\alpha = 1\)</span>, <span class="math inline">\(\beta = 5\)</span> to encourage sparsity.</li>
<li>Instead of sampling changepoint indicators, we integrate over all segmentations using these probabilities.</li>
</ul>
<p>This prior controls the <strong>expected segmentation complexity</strong>, preferring longer segments unless data suggests otherwise.</p>
</section>
<section id="marginal-likelihood-via-dynamic-programming" class="level3">
<h3 class="anchored" data-anchor-id="marginal-likelihood-via-dynamic-programming">2. Marginal Likelihood via Dynamic Programming</h3>
<p>The marginal likelihood component:</p>
<p><span class="math display">\[
p(\mathbf{y}_{1:T} \mid \boldsymbol{\pi}, \mu_{\text{chg}}, \sigma_{\text{chg}})
\]</span></p>
<p>is evaluated by <strong>marginalizing over all possible segmentations</strong> of the data into contiguous time intervals.</p>
</section>
<section id="precomputed-segment-log-likelihoods" class="level3">
<h3 class="anchored" data-anchor-id="precomputed-segment-log-likelihoods">2.1 Precomputed Segment Log-Likelihoods</h3>
<p>For every segment <span class="math inline">\([t_1, t_2]\)</span>, we compute:</p>
<p><span class="math display">\[
\ell_{t_1, t_2} = \log p(\mathbf{y}_{t_1:t_2})
\]</span></p>
<p>These are stored in a matrix of size <span class="math inline">\(T \times T\)</span>, and computed from: - Poisson or multinomial models of the observed histograms - Or another domain-specific scoring rule</p>
<p>Only the <strong>upper triangle</strong> (i.e., <span class="math inline">\(t_1 \leq t_2\)</span>) is valid.</p>
</section>
<section id="dynamic-programming-over-segmentations" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-programming-over-segmentations">2.2 Dynamic Programming over Segmentations</h3>
<p>Let <span class="math inline">\(L_t\)</span> be the log marginal likelihood of all paths ending at time <span class="math inline">\(t\)</span>. Then:</p>
<p><span class="math display">\[
L_{t_2} = \log \sum_{t_1=1}^{t_2-1} \exp \left[
    L_{t_1} +
    \log \pi_{t_1} +
    \log (1 - \pi_{t_1+1})^{(t_2 - t_1 - 1)} +
    \ell_{t_1, t_2 - 1} +
    \log p(\delta_{t_2-1} \mid \mu_{\text{chg}}, \sigma_{\text{chg}})
\right]
\]</span></p>
<p>We initialize with:</p>
<p><span class="math display">\[
L_1 = 0
\]</span></p>
<p>and compute forward to ( L_{T+1} ), which becomes the <strong>total marginal log-likelihood</strong> over all segmentation paths. This is added to the Stan <code>target</code>.</p>
</section>
<section id="prior-on-change-magnitudes" class="level3">
<h3 class="anchored" data-anchor-id="prior-on-change-magnitudes">3. Prior on Change Magnitudes</h3>
<p>We define a <strong>change magnitude</strong> at each <span class="math inline">\(t = 2, \dots, T\)</span>:</p>
<p><span class="math display">\[
\delta_t = \left| \mathbb{E}[p_t] - \mathbb{E}[p_{t-1}] \right|
\]</span></p>
<p>This is computed deterministically from the <strong>histogram of price bins</strong> on each day:</p>
<ul>
<li>The expectation ( [p_t] ) is taken with respect to the empirical price distribution on day <span class="math inline">\(t\)</span>.</li>
<li>These magnitudes are <strong>deterministic functions of the data</strong>.</li>
</ul>
<p>We place a <strong>Gaussian prior</strong> on these magnitudes:</p>
<p><span class="math display">\[
\delta_t \sim \mathcal{N}(\mu_{\text{chg}}, \sigma_{\text{chg}})
\]</span></p>
<p>with hyperpriors:</p>
<p><span class="math display">\[
\mu_{\text{chg}} \sim \mathcal{N}(0, 0.5), \quad \sigma_{\text{chg}} \sim \text{Exponential}(1)
\]</span></p>
<p>This introduces flexibility to favor larger or smaller changes in response to domain-specific expectations.</p>
<hr>
</section>
</section>
<section id="final-posterior-expression" class="level2">
<h2 class="anchored" data-anchor-id="final-posterior-expression">Final Posterior Expression</h2>
<p><span class="math display">\[
\begin{aligned}
\log p(\boldsymbol{\pi}, \mu_{\text{chg}}, \sigma_{\text{chg}} \mid \mathbf{y}_{1:T})
&amp;=
\sum_{t=2}^{T} \log \text{Beta}(\pi_t \mid 1, 5) \\
&amp;+ \log \mathcal{N}(\mu_{\text{chg}} \mid 0, 0.5) + \log \text{Exp}(\sigma_{\text{chg}} \mid 1) \\
&amp;+ \sum_{t=2}^{T} \log \mathcal{N}(\delta_t \mid \mu_{\text{chg}}, \sigma_{\text{chg}}) \\
&amp;+ \text{Marginal Log-Likelihood via DP}
\end{aligned}
\]</span></p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>When you click the <strong>Render</strong> button a document will be generated that includes both content and the output of embedded code. You can embed code like this:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="setup-1" class="level2">
<h2 class="anchored" data-anchor-id="setup-1">Setup</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix the random seed for reproducibility</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define number of observations, expected average transaction volume, and the number of days to simulate</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>n_days <span class="ot">&lt;-</span> <span class="dv">650</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>lambda_qty <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>days <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n_days</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify a sequence of price regimes with distinct list prices, discounts, and discount probabilities</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>segments <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">start_day =</span> <span class="fu">c</span>(<span class="dv">1</span>,  <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>, <span class="dv">550</span>, <span class="dv">600</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">list_price =</span> <span class="fu">c</span>(<span class="dv">5</span>,    <span class="dv">6</span>,   <span class="dv">6</span>,   <span class="dv">6</span>,   <span class="dv">6</span>, <span class="fl">5.5</span>, <span class="fl">5.5</span>, <span class="fl">5.5</span>),</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">discount_price =</span> <span class="fu">c</span>(<span class="dv">4</span>,    <span class="dv">4</span>,   <span class="dv">5</span>,   <span class="dv">5</span>,   <span class="dv">5</span>, <span class="fl">4.5</span>, <span class="fl">4.5</span>, <span class="fl">4.5</span>),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">discount_probability =</span> <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">1</span>,  .<span class="dv">1</span>, .<span class="dv">25</span>,  .<span class="dv">5</span>, .<span class="dv">01</span>, .<span class="dv">05</span>, .<span class="dv">15</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Map each day to its corresponding pricing regime</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>segment_id <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(days, segments<span class="sc">$</span>start_day)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a synthetic transactional record with total quantity and price assignment</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">day =</span> days, </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">list_price =</span> segments<span class="sc">$</span>list_price[segment_id],</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">discount_price =</span> segments<span class="sc">$</span>discount_price[segment_id],</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">discount_probability =</span> segments<span class="sc">$</span>discount_probability[segment_id],</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">qty_total =</span> <span class="fu">rpois</span>(n_days, lambda_qty)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">qty_discount =</span> <span class="fu">rbinom</span>(n_days, qty_total, discount_probability),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">qty_list_price =</span> qty_total <span class="sc">-</span> qty_discount</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(<span class="sc">-</span>discount_probability, <span class="sc">-</span>qty_total) <span class="sc">%&gt;%</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"qty_"</span>),</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"type"</span>,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"qty"</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">price =</span> <span class="fu">if_else</span>(type <span class="sc">==</span> <span class="st">"qty_discount"</span>, discount_price, list_price)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(day, price, qty)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the synthetic price trajectories over time.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Bubble size reflects quantity sold; red dashed lines denote predefined changepoints.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>p_price <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(qty <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(day, price)) <span class="sc">+</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size=</span>qty)) <span class="sc">+</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> segments<span class="sc">$</span>start_day[<span class="sc">-</span><span class="dv">1</span>], <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="changepoint_marginal_stan_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate total daily quantities and remove days with no transactions.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_nonzero <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">total_qty =</span> <span class="fu">sum</span>(qty), <span class="at">.by =</span> <span class="st">"day"</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(total_qty <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_qty)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the cleaned transactional data into a price-by-day matrix format.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Each row corresponds to a day; each column to a discretized price point.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>df_wide <span class="ot">&lt;-</span> df_nonzero <span class="sc">%&gt;%</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"price"</span>, <span class="at">values_from =</span> <span class="st">"qty"</span>, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a numeric matrix and enforce price column ordering.</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>histogram_qty <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df_wide[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>price_points <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">colnames</span>(histogram_qty))</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>histogram_qty <span class="ot">&lt;-</span> histogram_qty[,<span class="fu">order</span>(price_points)]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>price_points <span class="sc">%&lt;&gt;%</span> <span class="fu">sort</span>()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Structure data for Stan input as a list of matrix and metadata dimensions.</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>data_stan <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_time_points =</span> <span class="fu">nrow</span>(histogram_qty),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_price_points =</span> <span class="fu">ncol</span>(histogram_qty),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">histogram =</span> histogram_qty,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">price_points =</span> price_points</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compile-and-run-stan-model" class="level2">
<h2 class="anchored" data-anchor-id="compile-and-run-stan-model">Compile and Run Stan Model</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the custom Stan model for changepoint marginal likelihood computation</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./changepoint_marginal_simple.stan"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform optimization-based inference to obtain MAP estimates</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">optimize</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_stan,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Initial log joint probability = -4329.75 
    Iter      log prob        ||dx||      ||grad||       alpha      alpha0  # evals  Notes  
      67      -1399.24       139.121     0.0032305           1           1       79    
Optimization terminated normally:  
  Convergence detected: relative gradient magnitude is below tolerance 
Finished in  12.2 seconds.</code></pre>
</div>
</div>
</section>
<section id="analyze-estimated-changepoint-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="analyze-estimated-changepoint-probabilities">Analyze Estimated Changepoint Probabilities</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the estimated changepoint probabilities from the Stan model output</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cp_probs <span class="ot">&lt;-</span> opt<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"cp_probs"</span>) <span class="sc">%&gt;%</span> .<span class="sc">$</span>estimate <span class="sc">%&gt;%</span> <span class="fu">c</span>(., <span class="cn">NA</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Associate each time point (day) with its corresponding estimated changepoint probability</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df_estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">day =</span> df_wide<span class="sc">$</span>day, <span class="at">cp_probs =</span> cp_probs ) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cp_probs))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the changepoint probabilities over time using both point and bar representation</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>p_cp <span class="ot">&lt;-</span> df_estimates <span class="sc">%&gt;%</span> </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>day, <span class="at">y=</span>cp_probs)) <span class="sc">+</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"day"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Est. change probability"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine price plot and changepoint probability plot into a vertically stacked layout</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This facilitates visual comparison between observed pricing patterns and inferred changepoints</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(p_price <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>), p_cp, <span class="at">ncol =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="changepoint_marginal_stan_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="inspect-model-internals" class="level2">
<h2 class="anchored" data-anchor-id="inspect-model-internals">Inspect Model Internals</h2>
<section id="inspect-change-priors" class="level3">
<h3 class="anchored" data-anchor-id="inspect-change-priors">Inspect Change Priors</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lp_change_prior <span class="ot">&lt;-</span> opt<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lp_change_prior"</span>) <span class="sc">%&gt;%</span> .<span class="sc">$</span>estimate</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df_wide<span class="sc">$</span>day, lp_change_prior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="changepoint_marginal_stan_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="remarks-and-next-steps" class="level2">
<h2 class="anchored" data-anchor-id="remarks-and-next-steps">Remarks and Next Steps</h2>
<ul>
<li>This notebook uses synthetic data; future extensions can incorporate real price time series.</li>
<li>Model behavior can be improved by tuning the prior or increasing histogram resolution.</li>
<li>Consider extending to hierarchical changepoint models across multiple products or locations.</li>
</ul>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb10" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Bayesian Changepoint Detection on Price Histograms"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Pavel Logačev"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "r Sys.Date()"</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>This notebook presents a Bayesian changepoint detection model applied to synthetic sales data, where product prices change over time.</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>The goal is to detect structural changes in pricing behavior based on price histograms over time when the pricing of a product undergoes a meaningful shift — such as promotions, list price changes, or changes in the availability of discounts. </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>The model determines that based on daily price histograms (i.e., distributions of sold units across different price points). </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>The model is implemented in Stan and designed to serve as a modular component within larger hierarchical models for retail analytics.</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>The model marginalizes over all possible segmentations of the time series, using a dynamic programming algorithm to recursively compute the total marginal likelihood across all changepoint configurations. It is well-suited for integration in hierarchical settings where multiple products or locations share changepoint structure. This is especially useful when you want to detect coordinated changes across multiple products or stores.</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data and Problem Context</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each time point $t$ corresponds to a histogram of prices on that day, recording how many units were sold at each price.</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The goal is to identify when the distribution over prices changes in a meaningful way.</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>In practice, such changes might reflect promotions or price changes.</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Because real-world sales data is often sparse and noisy, the model uses probabilistic smoothing over changepoint locations, rather than hard thresholding.</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>We define:</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$y_t$: the observed **price histogram** at time $t$, represented as a vector over discretized price bins.</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\pi_t \in (0, 1)$: the **probability of a changepoint** between time $t$ and $t+1$.</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\delta_t$: the **change magnitude**, defined as the absolute difference in expected price between day $t$ and day $t-1$, based on histogram means.</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\theta$: parameters governing the prior distribution over $\delta_t$.</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. Bayesian Changepoint Detection on Price Histograms</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>This model addresses the problem of detecting changepoints in price histograms over time — points where the pricing behavior of a product undergoes a meaningful shift (e.g., due to promotion, repricing, or competitor reaction).</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>Instead of trying to detect changepoints deterministically or estimating their positions directly, the model marginalizes over all possible segmentations. It does this by:</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Precomputing the log-likelihood of each possible segment in a time series of price histograms.</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Using a prior over changepoints (interpreted as per-time probabilities).</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Recursively computing the marginal likelihood of the full sequence with a dynamic programming approach, integrating over all possible changepoint combinations.</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>This setup avoids sampling discrete changepoint positions and is designed to be embedded in a larger hierarchical model. For example, one can later use a common prior across products or sites and detect simultaneous price changes across products.</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>This method is particularly useful in retail pricing, where:</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Price change signals are noisy,</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Some products change price rarely or erratically,</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Detecting simultaneous changes across multiple products reveals coordinated promotions or systemic price shifts.</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Architecture</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>This model detects changepoints in a time series of price histograms by marginalizing over all possible segmentations in a Bayesian framework.</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>After each time point $k \in {1, \ldots, T-1}$, the model assumes that the current price regime either continues or changes. When a regime change occurs after point $k$ ($z_k=1$), we expect the price distribution to differ meaningfully from the previous one. This difference is governed by a prior over **change magnitudes**, parameterized by $\theta$.</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>Because Stan does not support discrete latent variables, we analytically marginalize over the binary regime change indicators $z_1:T-1$, and expresses the model directly in terms of $\pi_1:T-1$, the parameters governing the probability of a regime change between each pair of time points.</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>In the complete theoretical model, we would model the distributions associated with the different pricing regimes. However, in practice, doing so requires the estimation of an additional $T \cdot (T-1)/2 \cdot N$ parameters\footnote{$T \cdot (T-1)/2$ is the number of elements in the upper triangualar plus diagonal of a $T \times T$ matrix.}, where $T$ is the number of data points, and $N$ is the number of price points overall. The computational cost of this number of parameters appears prohibitively expensive, which is why the present model is simplified in two points:</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. </span>We do not explicitly model latent price distributions per segment. Instead, we use the observed histogram proportions directly to compute multinomial segment likelihoods.</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a><span class="ss">  2. </span>We apply the change magnitude prior not to the underlying distributional shift, but to the distance between the **first and last observed histograms** in a segment — for instance, via the absolute difference in mean prices.</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>The model’s components:</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$y_k$: Observed price histogram at time $k$.</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$<span class="sc">\\</span>pi_k$: Probability of a changepoint between $k$ and $k+1$.  </span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>  *(One parameter per time point, total: $T-1$)*</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$<span class="sc">\\</span>theta$: Parameters of the prior on how much the price distribution is expected to change after a regime shift.</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>The posterior is given by:</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>\underbrace{ p(\pi_{1:T-1}, \theta \mid \mathbf{y}_{1:T}) }_{\textbf{Posterior}}</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>\propto</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>\underbrace{ p( \pi_{1:T-1} ) }_{ \text{Changepoint prior} } \cdot </span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>\underbrace{ p( \theta ) }_{ \text{Prior on change magnitude} } \cdot </span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>\underbrace{ p( \mathbf{y}_{1:T} \mid \pi_{1:T-1}, \theta ) }_{</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>  \substack{</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>    \text{ Marginal likelihood } <span class="sc">\\</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    \text{ (multinomial segments, regime-change-weighted) }</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>The likelihood term integrates over all possible binary changepoint sequences consistent with the per-day probabilities $<span class="sc">\\</span>pi_k$, weighting each segmentation path by its segment likelihood and its compatibility with the prior over change magnitudes.</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>This model estimates changepoints in time-series histogram data by marginalizing over all possible segmentations using a Bayesian framework.</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>The posterior has three main components, each of which is described below.</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$y_k$: Price histogram for time point $k$.</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\pi_k$: Probability of a changepoint between $k$ and $k+1$. (Total number of parameters: $\text{number of time points} - 1$)</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\theta$: Parameters for the prior over the change magnitude at the changepoint between $k$ and $k+1$.</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>\underbrace{ p(\pi_{1:T-1}, \theta_{1:T} \mid \mathbf{y}_{1:T}) }_{Posterior}</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>  \propto</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>  \underbrace{ p( \pi_{1:T-1}) }_{\text{Changepoint prob. prior} } \cdot </span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>  \underbrace{ p( \mathbf{y}_{1:T} \mid \pi_{1:T-1}, \theta_{1:T} ) }_{\text{Marginal likelihood}} \cdot </span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>  \underbrace{ p( \theta_{1:T} ) }_{\text{Prior on the change magnitude}}</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Prior on Changepoint Probabilities</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>p(\boldsymbol{\pi}) = \prod_{t=2}^{T} \text{Beta}(\pi_t \mid \alpha, \beta)</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each $\pi_t \in (0, 1)$ represents the probability of a changepoint at time $t$.</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>These are treated as **independent latent variables**, typically with $\alpha = 1$, $\beta = 5$ to encourage sparsity.</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Instead of sampling changepoint indicators, we integrate over all segmentations using these probabilities.</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>This prior controls the **expected segmentation complexity**, preferring longer segments unless data suggests otherwise.</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Marginal Likelihood via Dynamic Programming</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>The marginal likelihood component:</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>p(\mathbf{y}_{1:T} \mid \boldsymbol{\pi}, \mu_{\text{chg}}, \sigma_{\text{chg}})</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>is evaluated by **marginalizing over all possible segmentations** of the data into contiguous time intervals.</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.1 Precomputed Segment Log-Likelihoods</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>For every segment $<span class="co">[</span><span class="ot">t_1, t_2</span><span class="co">]</span>$, we compute:</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>\ell_{t_1, t_2} = \log p(\mathbf{y}_{t_1:t_2})</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>These are stored in a matrix of size $T \times T$, and computed from:</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Poisson or multinomial models of the observed histograms</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Or another domain-specific scoring rule</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>Only the **upper triangle** (i.e., $t_1 \leq t_2$) is valid.</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.2 Dynamic Programming over Segmentations</span></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>Let $L_t$ be the log marginal likelihood of all paths ending at time $t$. Then:</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>L_{t_2} = \log \sum_{t_1=1}^{t_2-1} \exp \left[</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>    L_{t_1} +</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>    \log \pi_{t_1} +</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>    \log (1 - \pi_{t_1+1})^{(t_2 - t_1 - 1)} +</span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>    \ell_{t_1, t_2 - 1} +</span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>    \log p(\delta_{t_2-1} \mid \mu_{\text{chg}}, \sigma_{\text{chg}})</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>\right]</span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>We initialize with:</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>L_1 = 0</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>and compute forward to <span class="sc">\(</span> L_{T+1} <span class="sc">\)</span>, which becomes the **total marginal log-likelihood** over all segmentation paths. This is added to the Stan <span class="in">`target`</span>.</span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Prior on Change Magnitudes</span></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>We define a **change magnitude** at each $t = 2, \dots, T$:</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>\delta_t = \left| \mathbb{E}<span class="co">[</span><span class="ot">p_t</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">p_{t-1}</span><span class="co">]</span> \right|</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>This is computed deterministically from the **histogram of price bins** on each day:</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The expectation <span class="sc">\(</span> \mathbb{E}<span class="co">[</span><span class="ot">p_t</span><span class="co">]</span> <span class="sc">\)</span> is taken with respect to the empirical price distribution on day $t$.</span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>These magnitudes are **deterministic functions of the data**.</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>We place a **Gaussian prior** on these magnitudes:</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>\delta_t \sim \mathcal{N}(\mu_{\text{chg}}, \sigma_{\text{chg}})</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>with hyperpriors:</span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>\mu_{\text{chg}} \sim \mathcal{N}(0, 0.5), \quad \sigma_{\text{chg}} \sim \text{Exponential}(1)</span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>This introduces flexibility to favor larger or smaller changes in response to domain-specific expectations.</span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a><span class="fu">## Final Posterior Expression</span></span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>\log p(\boldsymbol{\pi}, \mu_{\text{chg}}, \sigma_{\text{chg}} \mid \mathbf{y}_{1:T})</span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a>&amp;=</span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a>\sum_{t=2}^{T} \log \text{Beta}(\pi_t \mid 1, 5) <span class="sc">\\</span></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a>&amp;+ \log \mathcal{N}(\mu_{\text{chg}} \mid 0, 0.5) + \log \text{Exp}(\sigma_{\text{chg}} \mid 1) <span class="sc">\\</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a>&amp;+ \sum_{t=2}^{T} \log \mathcal{N}(\delta_t \mid \mu_{\text{chg}}, \sigma_{\text{chg}}) <span class="sc">\\</span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a>&amp;+ \text{Marginal Log-Likelihood via DP}</span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:</span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE}</span></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a><span class="in"># Load required libraries</span></span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a><span class="in">library(magrittr)</span></span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a><span class="in">library(cmdstanr)</span></span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix the random seed for reproducibility</span></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Define number of observations, expected average transaction volume, and the number of days to simulate</span></span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>n_days <span class="ot">&lt;-</span> <span class="dv">650</span></span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>lambda_qty <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>days <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n_days</span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify a sequence of price regimes with distinct list prices, discounts, and discount probabilities</span></span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a>segments <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a>             <span class="at">start_day =</span> <span class="fu">c</span>(<span class="dv">1</span>,  <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">400</span>, <span class="dv">500</span>, <span class="dv">550</span>, <span class="dv">600</span>),</span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a>            <span class="at">list_price =</span> <span class="fu">c</span>(<span class="dv">5</span>,    <span class="dv">6</span>,   <span class="dv">6</span>,   <span class="dv">6</span>,   <span class="dv">6</span>, <span class="fl">5.5</span>, <span class="fl">5.5</span>, <span class="fl">5.5</span>),</span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a>        <span class="at">discount_price =</span> <span class="fu">c</span>(<span class="dv">4</span>,    <span class="dv">4</span>,   <span class="dv">5</span>,   <span class="dv">5</span>,   <span class="dv">5</span>, <span class="fl">4.5</span>, <span class="fl">4.5</span>, <span class="fl">4.5</span>),</span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a>  <span class="at">discount_probability =</span> <span class="fu">c</span>(.<span class="dv">25</span>, .<span class="dv">1</span>,  .<span class="dv">1</span>, .<span class="dv">25</span>,  .<span class="dv">5</span>, .<span class="dv">01</span>, .<span class="dv">05</span>, .<span class="dv">15</span>)</span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a><span class="co"># Map each day to its corresponding pricing regime</span></span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a>segment_id <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(days, segments<span class="sc">$</span>start_day)</span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a synthetic transactional record with total quantity and price assignment</span></span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>    <span class="at">day =</span> days, </span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">list_price =</span> segments<span class="sc">$</span>list_price[segment_id],</span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">discount_price =</span> segments<span class="sc">$</span>discount_price[segment_id],</span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">discount_probability =</span> segments<span class="sc">$</span>discount_probability[segment_id],</span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">qty_total =</span> <span class="fu">rpois</span>(n_days, lambda_qty)</span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">qty_discount =</span> <span class="fu">rbinom</span>(n_days, qty_total, discount_probability),</span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">qty_list_price =</span> qty_total <span class="sc">-</span> qty_discount</span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(<span class="sc">-</span>discount_probability, <span class="sc">-</span>qty_total) <span class="sc">%&gt;%</span></span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(</span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"qty_"</span>),</span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"type"</span>,</span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"qty"</span></span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">price =</span> <span class="fu">if_else</span>(type <span class="sc">==</span> <span class="st">"qty_discount"</span>, discount_price, list_price)</span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(day, price, qty)</span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the synthetic price trajectories over time.</span></span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a><span class="co"># Bubble size reflects quantity sold; red dashed lines denote predefined changepoints.</span></span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a>p_price <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(qty <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(day, price)) <span class="sc">+</span> </span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">size=</span>qty)) <span class="sc">+</span> </span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> segments<span class="sc">$</span>start_day[<span class="sc">-</span><span class="dv">1</span>], <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) </span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_price)</span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate total daily quantities and remove days with no transactions.</span></span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a>df_nonzero <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>( <span class="at">total_qty =</span> <span class="fu">sum</span>(qty), <span class="at">.by =</span> <span class="st">"day"</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(total_qty <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_qty)</span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the cleaned transactional data into a price-by-day matrix format.</span></span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Each row corresponds to a day; each column to a discretized price point.</span></span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a>df_wide <span class="ot">&lt;-</span> df_nonzero <span class="sc">%&gt;%</span> </span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"price"</span>, <span class="at">values_from =</span> <span class="st">"qty"</span>, <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to a numeric matrix and enforce price column ordering.</span></span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a>histogram_qty <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df_wide[,<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a>price_points <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">colnames</span>(histogram_qty))</span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a>histogram_qty <span class="ot">&lt;-</span> histogram_qty[,<span class="fu">order</span>(price_points)]</span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a>price_points <span class="sc">%&lt;&gt;%</span> <span class="fu">sort</span>()</span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a><span class="co"># Structure data for Stan input as a list of matrix and metadata dimensions.</span></span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a>data_stan <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_time_points =</span> <span class="fu">nrow</span>(histogram_qty),</span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_price_points =</span> <span class="fu">ncol</span>(histogram_qty),</span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a>  <span class="at">histogram =</span> histogram_qty,</span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a>  <span class="at">price_points =</span> price_points</span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a><span class="fu">## Compile and Run Stan Model</span></span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile the custom Stan model for changepoint marginal likelihood computation</span></span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"./changepoint_marginal_simple.stan"</span>)</span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform optimization-based inference to obtain MAP estimates</span></span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a>opt <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">optimize</span>(</span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_stan,</span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span></span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analyze Estimated Changepoint Probabilities</span></span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the estimated changepoint probabilities from the Stan model output</span></span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>cp_probs <span class="ot">&lt;-</span> opt<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"cp_probs"</span>) <span class="sc">%&gt;%</span> .<span class="sc">$</span>estimate <span class="sc">%&gt;%</span> <span class="fu">c</span>(., <span class="cn">NA</span>)</span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a><span class="co"># Associate each time point (day) with its corresponding estimated changepoint probability</span></span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>df_estimates <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">day =</span> df_wide<span class="sc">$</span>day, <span class="at">cp_probs =</span> cp_probs ) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cp_probs))</span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the changepoint probabilities over time using both point and bar representation</span></span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a>p_cp <span class="ot">&lt;-</span> df_estimates <span class="sc">%&gt;%</span> </span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>day, <span class="at">y=</span>cp_probs)) <span class="sc">+</span> </span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span> </span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"day"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Est. change probability"</span>)</span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine price plot and changepoint probability plot into a vertically stacked layout</span></span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a><span class="co"># This facilitates visual comparison between observed pricing patterns and inferred changepoints</span></span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(p_price <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>), p_cp, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a><span class="fu">## Inspect Model Internals</span></span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspect Change Priors</span></span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a>lp_change_prior <span class="ot">&lt;-</span> opt<span class="sc">$</span><span class="fu">summary</span>(<span class="st">"lp_change_prior"</span>) <span class="sc">%&gt;%</span> .<span class="sc">$</span>estimate</span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(df_wide<span class="sc">$</span>day, lp_change_prior)</span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a><span class="fu">## Remarks and Next Steps</span></span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>This notebook uses synthetic data; future extensions can incorporate real price time series.</span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Model behavior can be improved by tuning the prior or increasing histogram resolution.</span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider extending to hierarchical changepoint models across multiple products or locations.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>