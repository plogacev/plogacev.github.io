{
  "hash": "1c0ad9f90ee134add7720c0ce796ca7d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"A Hidden-Markov Model of Stockout Detection\"\nsubtitle: \"Bayesian HMM for detecting unobserved inventory outages\"\ndate: 2025-07-14\nimage: images/hmm_complete.svg\nformat:\n  html:\n    toc: true\n    code-fold: true\n    code-tools: true\n    df-print: paged\nengine: knitr\neditor: visual\n---\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(dotenv)\n#library(digest)\nlibrary(tidyverse)\nlibrary(magrittr)\n#library(lubridate)\nlibrary(pscl)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# simulates stockouts (we're assuming only full stockouts, no partial ones)\ngenerate_data <- function(n_days, lambda_base, stockouts_idx, seed = 12)\n{\n    # use average lambda; no seasonality for now\n    lambda_day <- rep(lambda_base, n_days) #+ (1:n_days)\n\n    # simulate latent sales, what would be realized if\n    set.seed(seed)\n    latent_demand_day <- rpois(n_days, lambda_day)\n\n    # create stockout indicator\n    inventory_sufficient <- rep(T, n_days)\n    valid_stockouts_idx <- stockouts_idx[stockouts_idx < n_days]\n    inventory_sufficient[valid_stockouts_idx] <- F\n\n    # we'll assume that stockouts don't increase sales afterwards\n    sales <- latent_demand_day * inventory_sufficient\n\n    state <- ifelse(inventory_sufficient, 'regular sales', 'stockout')\n    state %<>% factor(levels = c('stockout', 'regular sales'))\n\n    data.frame( day = 1:n_days, sales = sales, state = state ) # stockout = !inventory_sufficient,\n}\n```\n:::\n\n\n\n## Summary\n\nBayesian Hidden Markov Model for detecting stockouts in sales data with no explicit inventory information. A synthetic dataset is generated with steady latent demand and known stockout periods to demonstrate the principle. Realized sales are treated as true demand realizations except during stockouts, which structurally force sales to zero and hide actual demand. The model treats sales as emissions from two hidden states - regular sales and stockout - with state transitions governed by a Markov process. Inference is performed in Stan using MAP estimation and the Viterbi algorithm to recover the most likely stockout periods. The result shows how probabilistic state-switching can uncover unobserved stockouts that distort sales data.\n\n## Introduction\n\nIn this notebook, we tackle a common data problem in analyzing retail data: Realized sales don't always reflect the actual demand for a product. This is because when a product goes out of stock, the realized sales are artificially forced to zero, while the latent demand remains what it would have been.\n\nThis breaks the direct link between what is observed and what you'd want to use in an analysis or a forecast. If all realized sales are treated as if they came directly from the latent demand distribution, true demand will be underestimated.\n\nThis is a problem, because without explicit inventory data, the only clue about stockouts is that observed sales deviate from what the latent demand distribution could plausibly be.\n\n## Simulating Sales With Stockouts\n\nWe generate synthetic sales data with steady demand and no seasonality, including a single stockout period to demonstrate the issue and its solution.\n\nThe function `generate_data()` below simulates:\n\n-   Regular sales: The realized sales depend entirely on the latent demand, and are simulated as draws from a Poisson distribution.\n-   Stockout: Periods with no inventory, causing realized sales to drop to zero.\n\nThis gives us a clean example where we know which zeros are stockouts and which are a part of regular sales.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- generate_data( n_days = 90, lambda_base = 3,\n                     stockouts_idx = c(30:36, 71:80), #, 100:120, 150:163, 200:218, 250:260)\n                   )\n```\n:::\n\n\n\nThe plot shows flatlined realized during the stockout period, despite a constant latent demand distribution.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% ggplot(aes(day, sales, group=1, color = state)) +\n                    geom_line(color=\"darkgrey\") + geom_point() +\n                    theme_bw() + theme(legend.position = \"top\") +\n                    guides(color = guide_legend(title = NULL)) +\n                    ylab(\"sales quantity\") +\n                    ggtitle(\"Sales Over Time\") +\n                    theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n## Detecting Stockouts\n\nSo how do we detect stockouts? In order to do that, we first need to determine (i) the number of stockout days, and (ii) identify stretches of zeros the duration of which total approximately that length.\n\nDetermining the number of stockout days is relatively straightforward under the relatively plausible assumption that sales quantities are at least approximately follow the negaive binomial distribution: As is visible in the histogram below, the number of $0$s is unexpectedly large given the rest of the distribution. It should be smaller than the number of $1$s, but it is larger.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% ggplot(aes(sales)) + #, fill = state\n                    geom_histogram(bins = 30) + theme_bw() + theme(legend.position = \"top\") +\n                    guides(fill = guide_legend(title = NULL)) +\n                    xlab(\"sales quantity\") +\n                    scale_x_continuous(breaks=0:12) +\n                    ggtitle(\"Distribution of Sales Volume\") +\n                    theme(plot.title = element_text(hjust = 0.5))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=576}\n:::\n:::\n\n\n\nWe can use a zero-inflated negative binomial model to estimate a percentage of excess zeroes: One (simplified) way to think about it is that we fit a negative binomial distribution to all the non-zero quantites, and based on this estimated distribution determine the percentage of *expected* zeroes. The percentage above that are likely to be excess zeroes due to stockouts.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- pscl::zeroinfl(sales ~ 1 | 1, data = df, dist = \"negbin\")\nmu_hat <- exp( coef(model)[\"count_(Intercept)\"] )\ntheta_hat <- model$theta\nzi_coef <- coef(model)[[\"zero_(Intercept)\"]]\nexcess_zero_prob <- plogis(zi_coef)\n\ndf_zinb_mass <- data.frame(\n  n = c(0,                0:9),\n  p = c(excess_zero_prob,  dnbinom(0:9, size = theta_hat, mu = mu_hat)*(1-excess_zero_prob)),\n  excess_zeros = ifelse(0:10==0, \"excess zeroes\", \"regular sales\")\n)\n\np1 <- df_zinb_mass %>% ggplot(aes(x = n, y = p, fill = excess_zeros)) +\n                    geom_bar(stat = \"identity\", width = 0.3) + theme_bw() + theme(legend.position = \"top\") +\n                    guides(fill = guide_legend(title = NULL)) +\n                    xlab(\"sales quantity\") +\n                    scale_x_continuous(breaks=0:12)\n\np2 <- df %>% group_by(sales, state) %>% count() %>%\n                    ggplot(aes(x = sales, y = n, fill = state)) +\n                    geom_bar(stat = \"identity\", width = 0.3) + theme_bw() + theme(legend.position = \"top\") +\n                    guides(fill = guide_legend(title = NULL)) +\n                    xlab(\"sales quantity\") +\n                    scale_x_continuous(breaks=0:12)\n\nggpubr::ggarrange(p1, p2 )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=960}\n:::\n:::\n\n\n\nHowever, while this method helps us understand approximately what proportion of days are affected by stockous, it doesn't help us determine when exactly the stockouts occur. Some of the zeros are absolutely expected, even without a stockout.\n\n## A Probabilistic Model of Stockouts\n\nThe key to a good stockout detection algorithm is that we need to posit stockouts where zeroes occur rather unexpectedly. This can happen when sales suddenly drop to zero\n\na.  during a period with relatively high sales before and after the zero-sales stretch\nb.  when sales have historically been rather high, or when\nc.  when the number of successive zeroes is too long to be a coincidence during regular sales.\n\nTo detect such stockouts, we develop a probabilistic model based on the following principles:\n\n-   The latent demand follows a specific distribution (e.g., Negative Binomial with $\\mu$ and $\\theta$) that governs how many units would be sold if the stock were unlimited.\n-   The parameter $\\mu$ may depend on seasonal factors and may incorporate a trend.\n-   The realized sales on any given day is either the latent demand, or $0$, such as during a stockout.\n-   On any given day, the system is in a particular state (*stockout* or *regular sales*) and transitions between states are each associated with specific probabilities.\n\n### Details\n\nWe model the phenomenon using a Hidden Markov Model with the structure in the diagram below: Each day is spent to be in one of two hidden states:\n\n1.  Regular sales state ($R$): realized sales come from the latent demand distribution.\n\n2.  Stockout state ($S$): realized sales must be zero. The latent demand distribution is irrelevant because you can't fulfill any of it.\n\n![State Diagram of the Stockout HMM.](images/hmm_complete.svg)\n\nTransitions between states are governed by a Markov process. The probability of staying in the regular sales state on day $t+1$, given one was in that state on day $t$ is $\\pi_{RR}$.\n\nThe forward algorithm computes the likelihood of your entire observed series by marginalizing over all possible state sequences, given the emission distributions:\n\n1.  In the regular state, emissions come from the latent demand distribution, a negative binomial with parameters to be estimated.\n\n2.  In the stockout state, the emission is always zero.\n\nThe HMM is implemented as a Bayesian model in Stan, and we use MAP estimation to first obtain parameter estimates for the transition probabilites and the negative binomial parameters, and then use the Viterbi algorithm generating the most likely sequence of states generating the observed sequence of sales.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cmdstanr)\n\n# Compile the custom Stan model\nmodel <- cmdstan_model(\"./stockouts_v1.stan\")\n\ndata_stan <- list(n_days = nrow(df), sales_qty = df$sales )\n\nopt <- model$optimize(\n  data = data_stan,\n  seed = 123,\n  iter = 5000\n)\n\n#opt$summary()\n\ngq <- model$generate_quantities(\n  fitted_params = opt$draws(),\n  data = data_stan\n)\n\nlikely_state <- gq$summary()$mean\ndf$likely_state <- ifelse(likely_state == 2, \"regular sales\", \"stockout\")\n```\n:::\n\n\n\nThe plot below shows sales sequence generated above, with the red bands indicating the periods that have been identified as stockouts.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndatected_stockouts <- df %>%\n          mutate(prev_likely_state = lag(likely_state, default = \"0\"),\n                 change = (likely_state != prev_likely_state),\n                 segment_id = cumsum(change)) %>%\n          filter( likely_state == \"stockout\" ) %>%\n          group_by(segment_id) %>%\n          summarize( day_start = min(day), day_end = max(day) )\n\ndf %>% ggplot(aes(day, sales, group=1, color = state)) +\n                    geom_line(color=\"darkgrey\") + geom_point() +\n                    theme_bw() + theme(legend.position = \"top\") +\n                    guides(color = guide_legend(title = NULL)) +\n                    ylab(\"sales quantity\") +\n                    ggtitle(\"Sales Over Time\") +\n                    theme(plot.title = element_text(hjust = 0.5)) +\n                    geom_rect(\n                      data = datected_stockouts,\n                      inherit.aes = FALSE,\n                      aes( xmin = day_start, xmax = day_end,\n                           ymin = -Inf, ymax = Inf\n                      ),\n                      fill = \"red\",\n                      alpha = 0.2\n                    )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/thumbnail-image-1.png){width=672}\n:::\n:::\n\n\n\n# Limitations\n\n-   The current model does not implement seasonality, yearly or weekly.\n-   It does not account for the fact that unusual spikes in demand are more likely to be followed by stockouts than below-average sales.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}